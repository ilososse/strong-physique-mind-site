<!DOCTYPE html>
<html lang="fr">
  
<head>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://lmblqxwssrxucbtowfkq.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_8cLzA_3Ud6AaLSi8mTf1Gw_4lJZTLjs";

    // cr√©ation unique du client
    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <meta charset="UTF-8" />
  <title>Programmes & progression ‚Äì Calisth√©nie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/entrainements.css">
  <link rel="icon" type="image/png" href="images/favicon.png">

</head>
<body>
  <header>
    <a href="index.html" class="logo">
  <img src="images/logo.png" alt="Logo Calisth√©nie & ambition">
  <span>Calisth√©nie & ambition</span>
</a>


    <nav>
      <a href="index.html">Accueil</a>
      <a href="entrainements.html">Programmes & progression</a>
      <a href="leaderboard.html" target="_blank" rel="noopener noreferrer">‚ú® Leaderboard ‚ú®</a>
    </nav>
  </header>

  <main>
    <!-- UI for login publications and feed -->    

<section class="structured-log" style="margin-top:16px;">
  <h2 class="section-title">Communaut√©</h2>
  <p style="font-size:14px;color:#555;">
    Publie ta premi√®re s√©ance (pseudo) et consulte le feed public pour t‚Äôinspirer. Attention, une fois ton pseudo saisi et valid√©, il n‚Äôest plus modifiable ! Plus bas tu trouveras l'outil d'entra√Ænement con√ßu par un athl√®te pour les athl√®tes !
  </p>

  <div class="session-meta" style="align-items:flex-end;">
    <label>
      Email (login)
      <input id="auth-email" type="email" placeholder="ton@email.com">
    </label>

    <label>
      Mot de passe
      <input id="auth-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </label>

    <button class="btn btn-secondary" type="button" onclick="signup();">
      S‚Äôinscrire
    </button>
    <button class="btn btn-primary" type="button" onclick="login();">
      Se connecter
    </button>
    <button class="btn btn-secondary" type="button" onclick="logout();">
      D√©connexion
    </button>
  </div>

  <div class="session-meta" style="margin-top:10px; align-items:flex-end;">
    <label>
      Pseudo (public)
      <input id="public-username" type="text" placeholder="ex: cali_ambition">
    </label>

    <button class="btn btn-primary" type="button" onclick="saveUsername()">
      Enregistrer mon pseudo
    </button>
      <div class="top-right-actions">
    <button id="autoSaveBtn" class="btn-auto-save">
      <span class="badge-new">LIVE</span>
      Enregistrer une s√©ance automatiquement en DIRECT
    </button>
  </div>
  </div>


  <div class="info" id="community-info"></div>

  <hr style="border:none;border-top:1px solid #eee;margin:14px 0;">

  <h3 style="margin:0 0 8px;font-size:15px;">Feed public (derni√®res s√©ances)</h3>
  <div id="public-feed"></div>




</section>

    <!-- INTRO -->
    <section class="hero">
      <h1>Programmes & journal de progression</h1>
      <p>
        Cette page pr√©sente un outil cl√© pour qui cr√©e la diff√©rence en terme de motivation : <strong> le suivi automatis√© de chaque s√©ance que tu r√©alises</strong>. <br>
        En tant qu'athl√®te, j'ai longuement r√™v√© d'avoir un tel outil √† ma disposition : d√©sormais, il est l√†, le hack, √† toi de jouer ! <br>
        En bas de cette page, je t'ai aussi propos√© trois grandes classes de niveaux ‚Äì <strong>d√©butant</strong>, <strong>interm√©diaire</strong>
        et <strong>avanc√© / pro</strong> ‚Äì avec des exemples de structures d‚Äôentra√Ænement. Il y a √©videmment une infinit√© de fa√ßons de combiner les exercices. Ma proposition est un point de d√©part. Sois libre de l'adapter √† ton niveau, en int√©grant des exercices √† difficult√© variable !
      </p>
      <p>
        L‚Äôid√©e est de :
      </p>
      <ul style="margin-top: 4px; padding-left: 18px; font-size: 14px;">
        <li>si besoin, choisir en bas de cette page un niveau qui te parle (ou en tester plusieurs),</li>
        <li>ex√©cuter les exercices selon ta capacit√© actuelle,</li>
        <li>documenter ta progression et tes ressentis au fil des s√©ances avec le super outil que je te propose en bas,</li>
        <li>appr√©cier au fil du temps ton progr√®s √† travers les courbes r√©alis√©es automatiquement √† partir de tes s√©ances.</li>
        <li> ‚ö†Ô∏è il est extr√™mement important de ne pas oublier de r√©aliser un √©chauffement des muscles avant d'attaquer les exercices.</li>
        <li> je t'invite √† lire 
  <a href="echauffement.html" target="_blank" style="text-decoration:none; color:#111; font-weight:500;">
    mon article
  </a> 
  sur l'√©chauffement pr√©sentant un exemple d'exercices pr√©parant √† l'effort physique.
</li>
</section>

    <!-- JOURNAL STRUCTUR√â (TABLEAU) -->
<section class="structured-log">
  <div class="structured-log-header">
    <h2 class="section-title">Journal structur√© de s√©ance</h2>
    <p style="font-size: 14px; color:#555;">
      Utilise ce tableau pour consigner une s√©ance pr√©cise : date, niveau, dur√©e, exercices,
      √©ventuel lest, r√©p√©titions par s√©rie et ressenti global. Les donn√©es sont stock√©es dans ton compte.
    </p>
  </div>

  <div class="session-meta">
    <label>
      Date de la s√©ance
      <input type="date" id="session-date" />
    </label>

    <label>
      Dur√©e (minutes)
      <input type="number" id="session-duration" min="0" step="1" />
    </label>
  </div>

  <div class="session-table-wrapper">
    <table class="session-table">
      <thead>
        <tr>
          <th>Exercice</th>
          <th>Lest (kg)</th>
          <th>S√©rie 1</th>
          <th>S√©rie 2</th>
          <th>S√©rie 3</th>
          <th>S√©rie 4</th>
          <th>S√©rie 5</th>
          <th>S√©rie 6</th>
          <th>S√©rie 7</th>
          <th>S√©rie 8</th>
          <th>Ressenti</th>
          <th></th>
        </tr>
      </thead>

      <tbody id="session-rows">
        <!-- lignes ajout√©es en JS -->
      </tbody>
    </table>
  </div>

  <div class="session-actions">
    <button class="btn btn-secondary" type="button" onclick="addExerciseRow()">
      Ajouter un exercice
    </button>
    <button class="btn btn-primary" type="button" onclick="saveStructuredSession()">
      Enregistrer la s√©ance
    </button>
  </div>

  <div class="info" id="session-save-info"></div>
        <div class="sessions-history">
        <h3 style="font-size: 15px; margin: 6px 0 4px;">Historique des s√©ances</h3>
        <p style="font-size: 12px; color:#555; margin:0 0 6px;">
          Les derni√®res s√©ances enregistr√©es s‚Äôaffichent ci-dessous.
        </p>
        <div id="sessions-history"></div>
      </div>

</section>

    <!-- TABLEAU DE BORD -->
    <section class="dashboard">
      <h2 class="section-title">Tableau de bord de progression</h2>
      <p style="font-size: 14px; color:#555;">
        S√©lectionne un exercice et une m√©trique pour visualiser ta progression au fil des s√©ances.
        Les donn√©es proviennent de ton journal structur√© et restent stock√©es uniquement dans ce navigateur.
      </p>


      <div class="dashboard-controls">
      <div class="control">
        <label>Exercice √† analyser</label>
        <div class="exercise-row">
          <select id="dashboard-exercise">
            <option value="Tractions">Tractions</option>
            <option value="Pompes">Pompes</option>
            <option value="Dips">Dips</option>
            <option value="Planche lean">Planche lean</option>
            <option value="Tuck planche">Tuck planche</option>
            <option value="Straddle planche">Straddle planche</option>
            <option value="Full planche">Full planche</option>
            <option value="Handstand">Handstand</option>
            <option value="One Arm Handstand">One Arm Handstand</option>
            <option value="Handstand Push Up">Handstand Push Up</option>
            <option value="Human Flag">Human Flag</option>
            <option value="Front Lever">Front Lever</option>
            <option value="Muscle Up">Muscle Up</option>
            <option value="__custom_reps__">Autre... (Reps)</option>
            <option value="__custom_hold__">Autre... (Hold)</option>

          </select>

          <input
            id="custom-exercise"
            type="text"
            placeholder="Nom de l'exercice"
            style="display:none;"
          />
        </div>
      </div>

      <div class="control">
        <label>M√©trique</label>
        <select id="dashboard-metric"></select>
      </div>
    </div>


    <div class="chart-wrapper">
      <canvas id="exercise-chart"></canvas>
    </div>

      <div class="info" id="dashboard-info"></div>
    </section>

        </section>

    <!-- ANNEXE : PROGRAMMES -->
    <section class="workouts">
      <h2>‚ÑπÔ∏è Programmes par niveau</h2>
      <p>
        Voici une base de travail. Tu peux t‚Äôen servir comme r√©f√©rence, comme point de d√©part,
        ou comme cadre pour organiser tes propres s√©ances.
      </p>

      <div class="workout-grid">
        <!-- D√©butant -->
        <article class="workout-card">
          <div class="workout-level">D√©butant</div>
          <h3>Routine full body simple</h3>
          <ul>
            <li>3 √ó 8‚Äì10 pompes inclin√©es (mains sur le sol / canap√©)</li>
            <li>3 √ó 10 squats au poids du corps</li>
            <li>3 √ó 20 s gainage planche</li>
            <li>3 √ó 5-10 tractions n√©gatives </li>
          </ul>
          <p>
            Objectif : apprendre les bases, sentir les mouvements, construire une premi√®re r√©gularit√©
            sans √©craser le syst√®me nerveux.
          </p>
        </article>

        <!-- Interm√©diaire -->
        <article class="workout-card">
          <div class="workout-level">Interm√©diaire</div>
          <h3>Routine traction / push</h3>
          <ul>
            <li>4 √ó 6‚Äì8 tractions strictes</li>
            <li>4 √ó 8‚Äì12 pompes classiques</li>
            <li>3 √ó 8 dips sur barres ou chaises</li>
            <li>4 x 10 s hold handstand au mur ou libre si tu es √† l'aise</li>
            <li>4 x 3-10s hold tuck planche </li>
            <li>4 x 3-7 handstand push ups si tu es tenace</li>
            

          </ul>
          <p>
            Objectif : consolider la force de base et pr√©parer le terrain pour les skills
            (muscle-up, front lever, planche variantes plus avanc√©es).
          </p>
        </article>

        <!-- Avanc√© / Pro -->
        <article class="workout-card">
          <div class="workout-level">Avanc√© / Pro</div>
          <h3>Session skills & explosivit√©</h3>
          <ul>
            <li>Muscle-up : 5‚Äì8 s√©ries de variations (explosives, assist√©es, n√©gatives)</li>
            <li>Front lever : 5 √ó 10‚Äì15 s sur ta progression actuelle (tuck, advanced tuck, straddle‚Ä¶)</li>
            <li>Handstand push ups: 4 x 3‚Äì12 (mur + freestanding)</li>
            <li>Planche : 5 x 3-10s sur la progression la plus adapt√©e (tuck, straddle ou full si tu te sens monstrueux)</li>
          </ul>
          <p>
            Objectif : d√©velopper les skills, la musculature, et la force d'un ogre.
          </p>
        </article>
      </div>
    </section>
  
  </main>


  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script>
/* =========================================================
   CalisthenicsAmbition ‚Äì entrainements.html (FULL SCRIPT)
   - Supabase v2 via window.supabaseClient (d√©j√† cr√©√© dans <head>)
   - Smooth UI: cache sessions + scheduler + anti double-render chart
   ========================================================= */

/* ---------- CONFIG / HELPERS ---------- */

const supabaseClient = window.supabaseClient;
if (!supabaseClient?.auth || typeof supabaseClient.from !== "function") {
  console.error("Supabase client invalide", supabaseClient);
}

function userIdToNumber1to1000(userId) {
  let hash = 0;
  for (let i = 0; i < userId.length; i++) {
    hash = (hash * 31 + userId.charCodeAt(i)) >>> 0;
  }
  return (hash % 1000) + 1; // 1 ‚Üí 1000
}


function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function uiInfo(msg) {
  const el = document.getElementById("community-info");
  if (el) el.textContent = msg || "";
}

function normalizeTodayISODate() {
  return new Date().toISOString().slice(0, 10);
}

async function getAuthedUserOrWarn(infoEl) {
  const { data, error } = await supabaseClient.auth.getUser();
  if (error) {
    console.error("[auth] getUser error", error);
    infoEl && (infoEl.textContent = "‚ùå Erreur auth (voir console).");
    return null;
  }
  if (!data?.user) {
    infoEl && (infoEl.textContent = "‚ö†Ô∏è Connecte-toi pour enregistrer et voir tes s√©ances.");
    return null;
  }
  return data.user;
}

/* ---------- EXERCISES ---------- */

const REPS_EXERCISES = [
  "Tractions","Pompes","Dips","Handstand Push Up","Muscle Up",
];

const HOLD_EXERCISES = [
  "Planche lean","Tuck planche","Straddle planche","Full planche",
  "Handstand","One Arm Handstand","Human Flag","Front Lever",
];

function isCustomHoldSelected() {
  const exerciseSelect = document.getElementById("dashboard-exercise");
  return exerciseSelect?.value === "__custom_hold__";
}

function isHoldExercise(name) {
  if (isCustomHoldSelected()) return true;
  return HOLD_EXERCISES.includes(name);
}

function getSelectedExerciseName() {
  const exerciseSelect = document.getElementById("dashboard-exercise");
  const customInput = document.getElementById("custom-exercise");
  if (!exerciseSelect) return "";

  const v = exerciseSelect.value;
  if (v === "__custom_reps__" || v === "__custom_hold__") {
    return (customInput?.value || "").trim();
  }
  return v;
}

/* =========================================================
   SMOOTH UI CORE: cache + scheduler + anti spam refresh
   ========================================================= */

let __uiBusy = false;
let __uiSeq = 0;

let __sessionsCache = [];
let __sessionsCacheUserId = null;
let __sessionsCacheAt = 0;

let __chartSeq = 0;
let __feedSeq = 0;
let __feedInFlight = null;

function debounce(fn, wait = 120) {
  let t = null;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), wait);
  };
}

function isSessionsCacheFresh() {
  return (Date.now() - __sessionsCacheAt) < 15000; // 15s
}

async function fetchSessionsIntoCache({ force = false } = {}) {
  const { data: authData, error: authErr } = await supabaseClient.auth.getUser();
  if (authErr) {
    console.error("[cache] auth error", authErr);
    return __sessionsCache || [];
  }

  const user = authData?.user;
  if (!user) {
    __sessionsCache = [];
    __sessionsCacheUserId = null;
    __sessionsCacheAt = Date.now();
    return __sessionsCache;
  }

  if (!force && __sessionsCacheUserId === user.id && isSessionsCacheFresh()) {
    return __sessionsCache;
  }

  const { data, error } = await supabaseClient
    .from("workout_sessions")
    .select("id, session_date, payload, created_at")
    .eq("user_id", user.id)
    .order("session_date", { ascending: true });

  if (error) {
    console.error("[cache] fetch sessions error", error);
    return __sessionsCache || [];
  }

  __sessionsCache = (data || [])
    .map(r => ({ id: r.id, ...(r.payload || {}) }))
    .filter(s => s && s.date);

  __sessionsCacheUserId = user.id;
  __sessionsCacheAt = Date.now();
  return __sessionsCache;
}

function mergeExercises(exercises) {
  const map = new Map();

  exercises.forEach(ex => {
    const key = `${ex.name}__${ex.mode}__${ex.weight || 0}`;

    if (!map.has(key)) {
      map.set(key, {
        ...ex,
        s1: "", s2: "", s3: "", s4: "",
        s5: "", s6: "", s7: "", s8: ""
      });
    }

    const target = map.get(key);

    const incoming = [ex.s1, ex.s2, ex.s3, ex.s4, ex.s5, ex.s6, ex.s7, ex.s8]
      .filter(v => v !== "" && v !== null && v !== undefined);

    const existing = [target.s1, target.s2, target.s3, target.s4,
                      target.s5, target.s6, target.s7, target.s8]
      .filter(v => v !== "" && v !== null && v !== undefined);

    const merged = [...existing, ...incoming].slice(0, 8);

    [
      target.s1, target.s2, target.s3, target.s4,
      target.s5, target.s6, target.s7, target.s8
    ] = [...merged, "", "", "", "", "", "", "", ""];
  });

  return Array.from(map.values());
}

function mergeSessionsByDayAndExercise(rows) {
  const map = new Map();

  rows.forEach(r => {
    const key = `${r.user_id || "self"}__${r.date || r.session_date}`;

    if (!map.has(key)) {
      map.set(key, {
        ...r,
        payload: {
          ...r.payload,
          exercises: []
        }
      });
    }

    const bucket = map.get(key);

    if (Array.isArray(r.payload?.exercises)) {
      bucket.payload.exercises.push(...r.payload.exercises);
    }
  });

  // üî• merge des exercices ici
  return Array.from(map.values()).map(s => ({
    ...s,
    payload: {
      ...s.payload,
      exercises: mergeExercises(s.payload.exercises)
    }
  }));
}


async function getStructuredSessions() {
  return await fetchSessionsIntoCache({ force: false });
}

function clearPrivateUI() {
  const hist = document.getElementById("sessions-history");
  if (hist) hist.innerHTML = "<p style='font-size:12px; color:#777;'>Connecte-toi pour voir tes s√©ances.</p>";

  const info = document.getElementById("session-save-info");
  if (info) info.textContent = "";

  const input = document.getElementById("public-username");
  if (input) {
    input.disabled = true;
    input.value = "";
    input.placeholder = "Connexion requise";
    input.title = "Connexion requise";
  }

  const dashInfo = document.getElementById("dashboard-info");
  if (dashInfo) dashInfo.textContent = "Connecte-toi pour voir ton tableau de bord.";

  if (exerciseChart) {
    exerciseChart.destroy();
    exerciseChart = null;
  }

  __sessionsCache = [];
  __sessionsCacheUserId = null;
  __sessionsCacheAt = Date.now();
}


function updateAuthUI(user) {
  const emailInput = document.getElementById("auth-email");
  const passInput = document.getElementById("auth-pass");

  const signupBtn = document.querySelector('button[onclick="signup();"]');
  const loginBtn  = document.querySelector('button[onclick="login();"]');

  if (user) {
    // üîí LOCK
    if (emailInput) {
      emailInput.disabled = true;
      emailInput.value = user.email || "";
      emailInput.title = "Connect√©";
    }

    if (passInput) {
      passInput.disabled = true;
      passInput.value = "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
      passInput.title = "Mot de passe masqu√©";
    }

    signupBtn && (signupBtn.disabled = true);
    loginBtn && (loginBtn.disabled = true);
  } else {
    // üîì UNLOCK
    if (emailInput) {
      emailInput.disabled = false;
      emailInput.value = "";
      emailInput.title = "";
    }

    if (passInput) {
      passInput.disabled = false;
      passInput.value = "";
      passInput.title = "";
    }

    signupBtn && (signupBtn.disabled = false);
    loginBtn && (loginBtn.disabled = false);
  }
}


const scheduleUIRefresh = (() => {
  const run = async ({ forceSessions = false, forceFeed = false } = {}) => {
    if (__uiBusy) return;
    __uiBusy = true;
    const my = ++__uiSeq;

    try {
      // feed (public)
      if (forceFeed) await loadPublicFeed({ force: true });
      else await loadPublicFeed();

      // user session
      const { data: sessData } = await supabaseClient.auth.getSession();
      const user = sessData?.session?.user || null;
      updateAuthUI(user);

      if (!user) {
        clearPrivateUI();
        return;
      }

      // username UI lock
      if (typeof initUsernameUI === "function") {
        await initUsernameUI();
        if (my !== __uiSeq) return;
      }

      // cache sessions once
      await fetchSessionsIntoCache({ force: forceSessions });
      if (my !== __uiSeq) return;

      // render private UI from cache only (no network)
      await renderStructuredSessionsHistory({ useCache: true });
      if (my !== __uiSeq) return;

      await renderExerciseChart();
    } finally {
      __uiBusy = false;
    }
  };

  return debounce(run, 120);
})();

/* =========================================================
   STRUCTURED LOG (table)
   ========================================================= */

function createExerciseRow(data) {
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td>
      <select class="ex-name">
        <option value="">‚Äì S√©lectionne ‚Äì</option>
        <option value="Tractions">Tractions</option>
        <option value="Pompes">Pompes</option>
        <option value="Dips">Dips</option>
        <option value="Planche lean">Planche lean</option>
        <option value="Tuck planche">Tuck planche</option>
        <option value="Straddle planche">Straddle planche</option>
        <option value="Full planche">Full planche</option>
        <option value="Handstand">Handstand</option>
        <option value="One Arm Handstand">One Arm Handstand</option>
        <option value="Handstand Push Up">Handstand Push Up</option>
        <option value="Human Flag">Human Flag</option>
        <option value="Front Lever">Front Lever</option>
        <option value="Muscle Up">Muscle Up</option>
        <option value="__custom_reps__">Autre... (Reps)</option>
        <option value="__custom_hold__">Autre... (Hold)</option>
      </select>
      <input type="text" class="ex-custom" placeholder="Nom de l'exercice‚Ä¶"
        style="display:none; margin-top:6px;" />
    </td>
    <td><input type="number" class="ex-weight" min="0" step="0.5" value="${data?.weight ?? 0}"></td>
    <td><input type="number" class="ex-s1" min="0" step="1" value="${data?.s1 || ""}"></td>
    <td><input type="number" class="ex-s2" min="0" step="1" value="${data?.s2 || ""}"></td>
    <td><input type="number" class="ex-s3" min="0" step="1" value="${data?.s3 || ""}"></td>
    <td><input type="number" class="ex-s4" min="0" step="1" value="${data?.s4 || ""}"></td>
    <td><input type="number" class="ex-s5" min="0" step="1" value="${data?.s5 || ""}"></td>
    <td><input type="number" class="ex-s6" min="0" step="1" value="${data?.s6 || ""}"></td>
    <td><input type="number" class="ex-s7" min="0" step="1" value="${data?.s7 || ""}"></td>
    <td><input type="number" class="ex-s8" min="0" step="1" value="${data?.s8 || ""}"></td>
    <td><input type="text" class="ex-ressenti" placeholder="Ressenti global" value="${data?.ressenti || ""}"></td>
    <td><button class="remove-row-btn" type="button" onclick="removeExerciseRow(this)">√ó</button></td>
  `;

  const select = tr.querySelector(".ex-name");
  const custom = tr.querySelector(".ex-custom");

  function syncRowCustom() {
    const v = select.value;
    const isCustom = (v === "__custom_reps__" || v === "__custom_hold__");
    custom.style.display = isCustom ? "block" : "none";
    if (!isCustom) custom.value = "";
  }

  select.addEventListener("change", syncRowCustom);
  syncRowCustom();

  if (data?.name) {
    tr.querySelector(".ex-name").value = data.name;
    syncRowCustom();
  }

  return tr;
}

function addExerciseRow(prefillData) {
  const tbody = document.getElementById("session-rows");
  if (!tbody) return;
  tbody.appendChild(createExerciseRow(prefillData));
}

function removeExerciseRow(btn) {
  const tr = btn.closest("tr");
  if (tr) tr.remove();
}

async function saveStructuredSession() {
  const dateInput = document.getElementById("session-date");
  const durationInput = document.getElementById("session-duration");
  const rows = document.querySelectorAll("#session-rows tr");
  const info = document.getElementById("session-save-info");
  const user = await getAuthedUserOrWarn(info);
  if (!user) return;

  if (!dateInput.value) dateInput.value = normalizeTodayISODate();

  const session = {
    date: dateInput.value,
    duration: durationInput.value || "",
    exercises: []
  };

  rows.forEach(row => {
    const selectVal = row.querySelector(".ex-name")?.value || "";
    const customVal = (row.querySelector(".ex-custom")?.value || "").trim();

    const isCustomReps = selectVal === "__custom_reps__";
    const isCustomHold = selectVal === "__custom_hold__";
    const isCustom = isCustomReps || isCustomHold;

    const name = isCustom ? customVal : selectVal;

    const mode = isCustom
      ? (isCustomHold ? "hold" : "reps")
      : (isHoldExercise(selectVal) ? "hold" : "reps");

    if (isCustom && !name) return;

    const weight = row.querySelector(".ex-weight")?.value || "0";
    const s1 = row.querySelector(".ex-s1")?.value || "";
    const s2 = row.querySelector(".ex-s2")?.value || "";
    const s3 = row.querySelector(".ex-s3")?.value || "";
    const s4 = row.querySelector(".ex-s4")?.value || "";
    const s5 = row.querySelector(".ex-s5")?.value || "";
    const s6 = row.querySelector(".ex-s6")?.value || "";
    const s7 = row.querySelector(".ex-s7")?.value || "";
    const s8 = row.querySelector(".ex-s8")?.value || "";
    const ressenti = (row.querySelector(".ex-ressenti")?.value || "").trim();

    if (name || s1 || s2 || s3 || s4 || s5 || s6 || s7 || s8 || ressenti || weight !== "0") {
      session.exercises.push({ name, mode, weight, s1, s2, s3, s4, s5, s6, s7, s8, ressenti });
    }
  });
  // ‚úÖ PATCH: r√©cup√©rer le pseudo depuis user_profiles (source de v√©rit√©)
  let publicUsername = "";

  try {
    const { data: profile, error: profErr } = await supabaseClient
      .from("user_profiles")
      .select("username")
      .eq("user_id", user.id)
      .maybeSingle();

    if (profErr) console.warn("[saveStructuredSession] profile fetch error", profErr);
    publicUsername = (profile?.username || "").trim();
  } catch (e) {
    console.warn("[saveStructuredSession] profile fetch crash", e);
  }

  // Fallback: si vraiment aucun pseudo, mets un libell√© neutre (PAS l'email)
  const userNumber = userIdToNumber1to1000(user.id);

  const safeDisplayUsername =
    publicUsername ||
    (user.user_metadata?.username || user.user_metadata?.name || "").toString().trim() ||
    `Utilisateur${userNumber}`;


  const row = {
    user_id: user.id,
    username: safeDisplayUsername,
    session_date: session.date,
    payload: session
  };


  info && (info.textContent = "‚è≥ Enregistrement Supabase...");

  const { error } = await supabaseClient.from("workout_sessions").insert([row]);
  if (error) {
    console.error("[save] supabase insert error", error);
    info && (info.textContent = "‚ùå Erreur Supabase (voir console).");
    return;
  }

  const d = new Date(session.date);
  const formatted = isNaN(d.getTime()) ? session.date : d.toLocaleDateString();
  info && (info.textContent = `‚úÖ S√©ance enregistr√©e pour le ${formatted} (Supabase).`);

  // ‚úÖ Smooth: one scheduled refresh
  scheduleUIRefresh({ forceSessions: true, forceFeed: true });
}

/* history render from cache (smooth) */
async function renderStructuredSessionsHistory({ useCache = false } = {}) {
  const container = document.getElementById("sessions-history");
  if (!container) return;

  const { data: sessData } = await supabaseClient.auth.getSession();
  const user = sessData?.session?.user || null;

  if (!user) {
    container.innerHTML =
      "<p style='font-size:12px; color:#777;'>Connecte-toi pour voir tes s√©ances.</p>";
    return;
  }

  const rawSessions = useCache
    ? (__sessionsCache || [])
    : await fetchSessionsIntoCache({ force: true });

  if (!rawSessions.length) {
    container.innerHTML =
      "<p style='font-size:12px; color:#777;'>Aucune s√©ance enregistr√©e pour l‚Äôinstant.</p>";
    return;
  }

  // 1) Grouper par DATE
  const byDate = new Map();
  rawSessions.forEach(s => {
    if (!s.date) return;
    if (!byDate.has(s.date)) byDate.set(s.date, []);
    byDate.get(s.date).push(s);
  });

  let html = "";

  // 2) Une carte par JOUR
  Array.from(byDate.entries())
    .sort((a, b) => new Date(b[0]) - new Date(a[0]))
    .forEach(([date, daySessions]) => {

      // 3) Merge par (name + weight)
      const exoMap = new Map();

      daySessions.forEach(s => {
        (s.exercises || []).forEach(ex => {
          const weight = Number(ex.weight || 0);
          const key = `${ex.name}__${weight}`;

          if (!exoMap.has(key)) {
            exoMap.set(key, {
              name: ex.name,
              mode: ex.mode,
              weight,
              values: [],
              ressenti: []
            });
          }

          const entry = exoMap.get(key);

          const nums = [ex.s1, ex.s2, ex.s3, ex.s4, ex.s5, ex.s6, ex.s7, ex.s8]
            .map(v => Number(v))
            .filter(v => Number.isFinite(v) && v > 0);

          entry.values.push(...nums);

          if (ex.ressenti) entry.ressenti.push(ex.ressenti);
        });
      });

      const d = new Date(date);
      const dateStr = isNaN(d.getTime()) ? date : d.toLocaleDateString();

      html += `
        <div class="session-card">
          <div class="session-card-header">
            <span class="label">S√©ance du ${escapeHtml(dateStr)}</span>
            <span>Dur√©e : ‚Äì min</span>
          </div>

          <ul class="session-card-exos">
            ${Array.from(exoMap.values()).map(ex => {
              const unit = ex.mode === "hold" ? "s" : "reps";
              const series = ex.values.join(" / ");
              const ressenti = ex.ressenti.length
                ? ` ‚Äì ${escapeHtml(ex.ressenti[ex.ressenti.length - 1])}`
                : "";
              const weightLabel = ex.weight > 0 ? ` (+${ex.weight}kg)` : "";

              return `
                <li>
                  ${escapeHtml(ex.name)}${weightLabel}
                  ${series ? ` ‚Äì ${escapeHtml(series)} ${unit}` : ""}
                  ${ressenti}
                </li>
              `;
            }).join("")}
          </ul>

          <button
            class="delete-session-btn"
            type="button"
            onclick="deleteSessionByDate('${date}')"
          >
            Supprimer la s√©ance du jour
          </button>
        </div>
      `;
    });

  container.innerHTML = html;
}



async function deleteSessionByDate(date) {
  const info = document.getElementById("session-save-info");
  const user = await getAuthedUserOrWarn(info);
  if (!user) return;
  // FACULTATIF pour prevenir les suppressions par inadvertance
  //const ok = confirm(`Supprimer TOUTES les s√©ances du ${date} ?`);
  //if (!ok) return;

  const { error } = await supabaseClient
    .from("workout_sessions")
    .delete()
    .eq("user_id", user.id)
    .eq("session_date", date);

  if (error) {
    console.error(error);
    info.textContent = "‚ùå Erreur suppression";
    return;
  }

  info.textContent = "‚úÖ S√©ance du jour supprim√©e";
  scheduleUIRefresh({ forceSessions: true, forceFeed: true });
}

/* =========================================================
   DASHBOARD (chart) ‚Äì smooth
   ========================================================= */

let exerciseChart = null;

function updateMetricOptions() {
  const exerciseSelect = document.getElementById("dashboard-exercise");
  const metricSelect = document.getElementById("dashboard-metric");
  if (!exerciseSelect || !metricSelect) return;

  const exName = exerciseSelect.value;
  metricSelect.innerHTML = "";

  let options = [];

  if (isHoldExercise(exName)) {
    options = [
      { value: "avg_hold", label: "Moyenne des holds" },
      { value: "max_hold", label: "Max des holds" },
      { value: "count_hold", label: "Nombre de holds" },
      { value: "sum_hold", label: "Somme des holds" }
    ];
  } else {
    options = [
      { value: "avg_reps", label: "Moyenne des reps" },
      { value: "max_rep", label: "Max des reps" },
      { value: "count_sets", label: "Nombre de s√©ries" },
      { value: "sum_reps", label: "Somme des reps" }
    ];
  }

  options.forEach(opt => {
    const o = document.createElement("option");
    o.value = opt.value;
    o.textContent = opt.label;
    metricSelect.appendChild(o);
  });
}
async function buildChartData(exerciseName, metricKey) {
  const sessions = await getStructuredSessions();

  // 1) Grouper par DATE
  const byDate = new Map();

  sessions.forEach(s => {
    if (!s.date) return;
    if (!byDate.has(s.date)) byDate.set(s.date, []);
    byDate.get(s.date).push(s);
  });

  const labels = [];
  const data = [];

  // 2) Un point par JOUR
  Array.from(byDate.entries())
    .sort((a, b) => new Date(a[0]) - new Date(b[0]))
    .forEach(([date, daySessions]) => {
      let values = [];

      daySessions.forEach(s => {
        const exercises = s.exercises || [];
        const matching = exercises.filter(ex =>
          ex.name === exerciseName && Number(ex.weight || 0) === 0
        );

        matching.forEach(ex => {
          const nums = [ex.s1, ex.s2, ex.s3, ex.s4, ex.s5, ex.s6, ex.s7, ex.s8]
            .map(v => Number(v))
            .filter(v => Number.isFinite(v) && v > 0);

          values.push(...nums);
        });
      });

      if (!values.length) return;

      let pointValue = 0;

      if (isHoldExercise(exerciseName)) {
        const sum = values.reduce((a, b) => a + b, 0);
        const avg = sum / values.length;
        const max = Math.max(...values);
        const count = values.length;

        if (metricKey === "avg_hold") pointValue = avg;
        else if (metricKey === "max_hold") pointValue = max;
        else if (metricKey === "count_hold") pointValue = count;
        else if (metricKey === "sum_hold") pointValue = sum;
      } else {
        const sum = values.reduce((a, b) => a + b, 0);
        const count = values.length;
        const avg = sum / count;
        const max = Math.max(...values);

        if (metricKey === "sum_reps") pointValue = sum;
        else if (metricKey === "avg_reps") pointValue = avg;
        else if (metricKey === "count_sets") pointValue = count;
        else if (metricKey === "max_rep") pointValue = max;
      }

      const d = new Date(date);
      const dateStr = isNaN(d.getTime()) ? date : d.toLocaleDateString();

      labels.push(dateStr);
      data.push(pointValue);
    });

  return { labels, data };
}

async function renderExerciseChart() {
  const my = ++__chartSeq;

  const exerciseSelect = document.getElementById("dashboard-exercise");
  const metricSelect = document.getElementById("dashboard-metric");
  const info = document.getElementById("dashboard-info");
  const ctx = document.getElementById("exercise-chart");

  if (!exerciseSelect || !metricSelect || !ctx) return;

  // if not authed, keep clean UI
  const { data: sessData } = await supabaseClient.auth.getSession();
  const user = sessData?.session?.user || null;
  if (!user) {
    info.textContent = "Connecte-toi pour voir ton tableau de bord.";
    if (exerciseChart) { exerciseChart.destroy(); exerciseChart = null; }
    return;
  }

  const exerciseName = getSelectedExerciseName();
  if (!exerciseName) {
    info.textContent = "Choisis un exercice ou saisis un nom pour l'exercice personnalis√©.";
    if (exerciseChart) { exerciseChart.destroy(); exerciseChart = null; }
    return;
  }

  const metricKey = metricSelect.value;

  // Persist UI choices locally
  localStorage.setItem("last-selected-exercise-select", exerciseSelect.value);
  localStorage.setItem("last-selected-exercise", exerciseName);
  localStorage.setItem("last-selected-metric", metricKey);

  const { labels, data } = await buildChartData(exerciseName, metricKey);

  // ‚úÖ ignore obsolete renders
  if (my !== __chartSeq) return;

  if (!labels.length) {
    info.textContent = "Aucune donn√©e trouv√©e pour cet exercice et cette m√©trique.";
    if (exerciseChart) { exerciseChart.destroy(); exerciseChart = null; }
    return;
  }

  info.textContent = "";

  if (exerciseChart) exerciseChart.destroy();

  exerciseChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: `${exerciseName} ‚Äì ${metricSelect.options[metricSelect.selectedIndex].text}`,
        data,
        borderWidth: 2,
        tension: 0.2,
        pointRadius: 3
      }]
    },
    plugins: [ChartDataLabels],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: { padding: { top: 24, right: 8, left: 4 } },
      scales: {
        x: { title: { display: true, text: "S√©ances" } },
        y: { title: { display: true, text: "Valeur" }, beginAtZero: true }
      },
      plugins: {
        legend: { position: "bottom" },
        datalabels: {
          anchor: "end",
          align: "top",
          offset: 4,
          font: { size: 10 },
          formatter: (value) => Number.isInteger(value) ? value : value.toFixed(1)
        }
      }
    }
  });
}

async function initDashboard() {
  const exerciseSelect = document.getElementById("dashboard-exercise");
  const metricSelect = document.getElementById("dashboard-metric");
  if (!exerciseSelect || !metricSelect) return;

  const customInput = document.getElementById("custom-exercise");

  // restore select
  const savedSelect = localStorage.getItem("last-selected-exercise-select");
  if (savedSelect) {
    const exists = Array.from(exerciseSelect.options).some(o => o.value === savedSelect);
    if (exists) exerciseSelect.value = savedSelect;
  }

  function syncCustomUI() {
    if (!customInput) return;
    const isCustom = (exerciseSelect.value === "__custom_reps__" || exerciseSelect.value === "__custom_hold__");
    customInput.style.display = isCustom ? "block" : "none";

    if (isCustom) {
      const key = (exerciseSelect.value === "__custom_hold__")
        ? "custom-hold-exercise-name"
        : "custom-reps-exercise-name";
      const savedName = localStorage.getItem(key) || "";
      if (!customInput.value) customInput.value = savedName;
    } else {
      // optional: keep value, or clear:
      // customInput.value = "";
    }
  }

  syncCustomUI();
  updateMetricOptions();

  const savedMetric = localStorage.getItem("last-selected-metric");
  if (savedMetric) {
    const exists = Array.from(metricSelect.options).some(o => o.value === savedMetric);
    if (exists) metricSelect.value = savedMetric;
  }

  await renderExerciseChart();

  // listeners (async-safe)
  exerciseSelect.addEventListener("change", async () => {
    syncCustomUI();
    updateMetricOptions();
    await renderExerciseChart();
  });

  metricSelect.addEventListener("change", async () => {
    await renderExerciseChart();
  });

  if (customInput) {
    customInput.addEventListener("input", async () => {
      const name = (customInput.value || "").trim();
      const key = (exerciseSelect.value === "__custom_hold__")
        ? "custom-hold-exercise-name"
        : "custom-reps-exercise-name";
      localStorage.setItem(key, name);
      await renderExerciseChart();
    });
  }
}

function initStructuredLog() {
  addExerciseRow();
}

/* =========================================================
   WORKOUTS SAVINGS AND POSTING (local only)
   ========================================================= */

function showPost(id) {
  for (let i = 1; i <= 4; i++) {
    const post = document.getElementById("post-" + i);
    const btn = document.getElementById("btn-post-" + i);
    if (!post || !btn) continue;

    if (i === id) {
      post.style.display = "block";
      btn.classList.add("active");
    } else {
      post.style.display = "none";
      btn.classList.remove("active");
    }
  }
}

function savePost(id) {
  const textarea = document.getElementById("textarea-" + id);
  const info = document.getElementById("info-" + id);
  const key = "journal-content-" + id;

  if (!textarea) return;
  localStorage.setItem(key, textarea.value);
  const now = new Date().toLocaleString();
  if (info) info.textContent = "Enregistr√© le " + now + ".";
}

function resetPost(id) {
  const textarea = document.getElementById("textarea-" + id);
  const info = document.getElementById("info-" + id);
  const key = "journal-content-" + id;

  if (textarea) textarea.value = "";
  localStorage.removeItem(key);
  if (info) info.textContent = "";
}

function loadPosts() {
  for (let i = 1; i <= 4; i++) {
    const textarea = document.getElementById("textarea-" + i);
    const info = document.getElementById("info-" + i);
    const key = "journal-content-" + i;

    if (!textarea) continue;
    const saved = localStorage.getItem(key);
    if (saved !== null) {
      textarea.value = saved;
      if (info) info.textContent = "Contenu r√©cup√©r√© depuis ce navigateur.";
    }
  }
  showPost(1);
}

/* =========================================================
   COMMUNITY: username + feed + auth
   ========================================================= */

async function getOrCreateUsername(inputUsername) {
  const { data: auth } = await supabaseClient.auth.getUser();
  const user = auth?.user;
  if (!user) return null;

  const { data: profile, error: selectError } = await supabaseClient
    .from("user_profiles")
    .select("username")
    .eq("user_id", user.id)
    .maybeSingle();

  if (selectError) {
    console.error(selectError);
    throw selectError;
  }

  if (profile?.username) return profile.username;

  const username = inputUsername.trim();
  if (!username) return null;

  const { error: insertError } = await supabaseClient
    .from("user_profiles")
    .insert({ user_id: user.id, username });

  if (insertError) {
    if (insertError.code === "23505") throw new Error("USERNAME_TAKEN");
    throw insertError;
  }

  return username;
}

async function initUsernameUI() {
  const input = document.getElementById("public-username");
  if (!input) return;

  // √©tat par d√©faut : verrouill√©
  input.disabled = true;
  input.value = "";
  input.title = "Connecte-toi pour d√©finir ton pseudo";

  const { data: auth } = await supabaseClient.auth.getUser();
  const user = auth?.user;

  // ‚ùå pas connect√© ‚Üí on laisse d√©sactiv√©
  if (!user) {
    return;
  }

  // ‚úÖ connect√© ‚Üí on v√©rifie le profil
  const { data: profile, error } = await supabaseClient
    .from("user_profiles")
    .select("username")
    .eq("user_id", user.id)
    .maybeSingle();

  if (error) {
    console.warn("initUsernameUI profile read error:", error);
    return;
  }

  // üîí pseudo d√©j√† d√©fini
  if (profile?.username) {
    input.value = profile.username;
    input.disabled = true;
    input.title = "Pseudo d√©finitif";
  } 
  // ‚úÖ connect√© mais pas encore de pseudo
  else {
    input.disabled = false;
    input.placeholder = "ex: cali_ambition";
    input.title = "Choisis ton pseudo (une seule fois)";
  }
}

function computeSessionPoints(payload) {
  const exos = payload?.exercises || [];
  let total = 0;

  for (const ex of exos) {
    const vals = [ex.s1, ex.s2, ex.s3, ex.s4, ex.s5, ex.s6, ex.s7, ex.s8]
      .map(v => Number(v))
      .filter(v => Number.isFinite(v) && v > 0);

    if (!vals.length) continue;
    total += vals.reduce((a, b) => a + b, 0);
  }

  return Math.round(total);
}

function renderFeedItem(s, currentUserId) {
  const d = new Date(s.session_date);
  const dateLabel = isNaN(d.getTime()) ? s.session_date : d.toLocaleDateString();

  const points = computeSessionPoints(s.payload);
  const trophy = `<span style="margin-left:8px;color:#d4af37;font-weight:700;">üèÜ ${points} pts</span>`;

  const exList = (s.payload?.exercises || [])
  .slice(0, 15)
  .map(ex => {
    const series = [ex.s1, ex.s2, ex.s3, ex.s4, ex.s5, ex.s6, ex.s7, ex.s8]
      .filter(v => v !== "" && v !== null && v !== undefined)
      .join("/");

    const unit = ex.mode === "hold" ? "s" : "reps";

    // ‚úÖ NOUVEAU : affichage du lest
    const weightNum = Number(ex.weight || 0);
    const weightLabel = weightNum > 0 ? ` (+${weightNum}kg)` : "";

    return `
      <li>
        ${escapeHtml(ex.name || "Exo")}${weightLabel}
        ${series ? ` ‚Äî ${escapeHtml(series)} ${unit}` : ""}
      </li>
    `;
  })
  .join("");

  const canDelete = currentUserId && s.user_id === currentUserId;

  return `
    <div style="background:#f5f5f5;border:1px solid #eee;border-radius:12px;padding:12px;">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:baseline;">
        <strong>${escapeHtml(s.username)}${trophy}</strong>
        <span style="font-size:12px;color:#666;">${escapeHtml(dateLabel)}</span>
      </div>

      <div style="font-size:12px;color:#666;margin-top:4px;">
        Dur√©e: ${escapeHtml(String(s.payload?.duration || ""))} min
      </div>

      <ul style="margin:8px 0 0;padding-left:18px;font-size:13px;">
        ${exList || "<li>(s√©ance vide)</li>"}
      </ul>

      ${canDelete ? `
        <button class="delete-session-btn" type="button" onclick="deleteSessionByDate('${s.session_date}')">
          Supprimer cette publication
        </button>
      ` : ""}
    </div>
  `;
}

function withTimeout(p, ms, code = "TIMEOUT") {
  let t;
  const timeout = new Promise((_, rej) => {
    t = setTimeout(() => rej(new Error(code)), ms);
  });
  return Promise.race([p, timeout]).finally(() => clearTimeout(t));
}

async function loadPublicFeed({ force = false } = {}) {
  const container = document.getElementById("public-feed");
  if (!container) return;

  if (__feedInFlight && !force) return __feedInFlight;

  const mySeq = ++__feedSeq;
  container.innerHTML = `<div style="font-size:13px;color:#666;">Chargement du feed...</div>`;

  const commit = (html) => {
    if (mySeq !== __feedSeq) return;
    container.innerHTML = html;
  };

  __feedInFlight = (async () => {
    try {
      // current user id (timeout)
      let currentUserId = null;
      try {
        const { data, error } = await withTimeout(supabaseClient.auth.getUser(), 1200, "AUTH_TIMEOUT");
        if (!error) currentUserId = data?.user?.id || null;
      } catch (_) {
        currentUserId = null;
      }

      // fetch feed (timeout)
      const { data, error } = await withTimeout(
        supabaseClient
          .from("workout_sessions")
          .select("id, user_id, created_at, username, session_date, payload")
          .order("created_at", { ascending: false })
          .limit(200),
        2500,
        "FEED_TIMEOUT"
      );

      if (error) {
        commit(`<div style="font-size:13px;color:#a00;">Erreur feed: ${escapeHtml(error.message)}</div>`);
        return;
      }

      if (!data || data.length === 0) {
        commit(`<div style="font-size:13px;color:#666;">Aucune s√©ance publique pour l‚Äôinstant.</div>`);
        return;
      }

      const merged = mergeSessionsByDayAndExercise(data);

      commit(
        merged
          .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
          .map(s => renderFeedItem(s, currentUserId))
          .join("")
      );

    } catch (e) {
      commit(`<div style="font-size:13px;color:#a00;">Feed indisponible (${escapeHtml(e?.message || String(e))})</div>`);
    } finally {
      if (mySeq === __feedSeq) __feedInFlight = null;
    }
  })();

  return __feedInFlight;
}

async function deleteSession(sessionId) {
  const { error } = await supabaseClient
    .from("workout_sessions")
    .delete()
    .eq("id", sessionId);

  if (error) {
    uiInfo("Erreur suppression : " + error.message);
    return;
  }

  uiInfo("S√©ance supprim√©e.");
  scheduleUIRefresh({ forceSessions: true, forceFeed: true });
}

// evol saveUsername does not do anything but register user's username now
async function saveUsername() {
  uiInfo("");

  const { data: authData } = await supabaseClient.auth.getUser();
  const user = authData?.user;
  if (!user) return uiInfo("Tu dois √™tre connect√© pour enregistrer ton pseudo.");

  const inputUsername = document.getElementById("public-username")?.value || "";

  let username;
  try {
    username = await getOrCreateUsername(inputUsername);
  } catch (e) {
    return uiInfo("Ce pseudo est d√©j√† utilis√©.");
  }

  if (!username) return uiInfo("Choisis un pseudo (une seule fois).");
  scheduleUIRefresh({ forceSessions: true, forceFeed: true });
}

/* ---------- AUTH ---------- */

async function login() {
  uiInfo("");

  const email = document.getElementById("auth-email")?.value?.trim().toLowerCase();
  const password = document.getElementById("auth-pass")?.value?.trim();
  if (!email || !password) return uiInfo("Email et mot de passe requis.");

  const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if (error) return uiInfo("Erreur login : " + error.message);

  uiInfo("Connect√© !");
  scheduleUIRefresh({ forceSessions: true, forceFeed: true });
}

async function signup() {
  uiInfo("");

  const email = document.getElementById("auth-email")?.value?.trim().toLowerCase();
  const password = document.getElementById("auth-pass")?.value?.trim();
  if (!email || !password) return uiInfo("Email et mot de passe requis.");

  const { data, error } = await supabaseClient.auth.signUp({ email, password });
  if (error) return uiInfo("Erreur inscription : " + error.message);

  if (data?.session) uiInfo("Inscription OK + connect√©.");
  else uiInfo("Inscription OK. V√©rifie tes emails si confirmation requise.");

  scheduleUIRefresh({ forceSessions: true, forceFeed: true });
}

let isLoggingOut = false;

async function logout() {
  if (isLoggingOut) return;
  isLoggingOut = true;

  const btns = document.querySelectorAll('button[onclick="logout()"]');
  btns.forEach(b => (b.disabled = true));

  try {
    uiInfo("D√©connexion...");

    const signOutPromise = supabaseClient.auth.signOut();
    const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("TIMEOUT_SIGNOUT")), 1200));
    await Promise.race([signOutPromise, timeoutPromise]);

    uiInfo("D√©connect√©.");
  } catch (e) {
    if (e?.message === "TIMEOUT_SIGNOUT") {
      uiInfo("D√©connect√© (UI). Rechargement...");
      window.location.reload();
      return;
    }
    uiInfo("Erreur logout : " + (e?.message || e));
  } finally {
    clearPrivateUI();
    scheduleUIRefresh({ forceSessions: true, forceFeed: true });
    isLoggingOut = false;
    btns.forEach(b => (b.disabled = false));
  }
}

function bindAuthListenerOnce() {
  if (window.__authListenerBound) return;
  window.__authListenerBound = true;

  supabaseClient.auth.onAuthStateChange(() => {
    scheduleUIRefresh({ forceSessions: true, forceFeed: true });
  });
}

function bindVisibilityRefresh() {
  if (window.__visibilityBound) return;
  window.__visibilityBound = true;

  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) loadPublicFeed({ force: true });
  });

  window.addEventListener("focus", () => {
    loadPublicFeed({ force: true });
  });
}

/* ---------- AUTO SAVE / COUNTER TOOL LAUNCH ---------- */

function bindAutoSaveButton() {
  const btn = document.getElementById("autoSaveBtn");
  if (!btn) return;

  btn.addEventListener("click", async () => {
    const { data: authData } = await supabaseClient.auth.getUser();
    const user = authData?.user;
    if (!user) {
      alert("Tu dois √™tre connect√©.");
      return;
    }

    // username public (si tu veux le passer)
    const username = user.user_metadata?.username || "";

    const ctx = {
      userId: user.id,
      username,
      exercise: "Tractions",
      mode: "pullups",
      sessionDate: new Date().toISOString().slice(0,10),
    };

    const encoded = encodeURIComponent(btoa(JSON.stringify(ctx)));
    window.location.href = `/counter/launcher.html?ctx=${encoded}`;
  });
}

/* =========================================================
   BOOT
   ========================================================= */

window.addEventListener("DOMContentLoaded", async () => {
  // init base UI
  initStructuredLog();
  loadPosts();
  bindAutoSaveButton();

  // restore dashboard state
  const exerciseSelect = document.getElementById("dashboard-exercise");
  const savedSelect = localStorage.getItem("last-selected-exercise-select");
  if (savedSelect && exerciseSelect) {
    exerciseSelect.value = savedSelect;
  }

  // init dashboard (sets listeners + first render)
  await initDashboard();

  // auth + feed refresh
  bindAuthListenerOnce();
  bindVisibilityRefresh();

  // username lock
  await initUsernameUI();

  // first refresh (groups feed + sessions + chart)
  scheduleUIRefresh({ forceSessions: true, forceFeed: true });
});

/* expose onclick handlers */
window.addExerciseRow = addExerciseRow;
window.removeExerciseRow = removeExerciseRow;
window.saveStructuredSession = saveStructuredSession;

window.saveUsername = saveUsername;

window.login = login;
window.signup = signup;
window.logout = logout;

window.showPost = showPost;
window.savePost = savePost;
window.resetPost = resetPost;

window.loadPublicFeed = loadPublicFeed;
window.deleteSessionByDate = deleteSessionByDate;
</script>

</body>
</html>
