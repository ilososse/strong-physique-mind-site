import"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";import{FilesetResolver as _,PoseLandmarker as C}from"https://esm.sh/@mediapipe/tasks-vision@0.10.14";import{e as W,s as X,v as o,b as z,a as T,d as A,F as O,D as U,N as K,H as N,h as j,P as Q,T as G,i as D,j as x}from"./exercises-BewMERDx.js";const $=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);function w(H){return{...H,_poseMetrics(s){const e=s[11],t=s[12],i=s[13],r=s[14],c=s[23],h=s[24],p=s[15],u=s[16],d=s[27],n=s[28],g=s[25],S=s[26],m=o(e,.45)&&o(i,.45)&&o(c,.45)&&o(p,.45)&&o(d,.45),y=o(t,.45)&&o(r,.45)&&o(h,.45)&&o(u,.45)&&o(n,.45),L=m?x(e,c,d):null,M=y?x(t,h,n):null,l=m?Math.abs(e.y-c.y):null,a=y?Math.abs(t.y-h.y):null,f=m?x(i,e,c):null,v=y?x(r,t,h):null,E=m?e.x-p.x:null,b=y?t.x-u.x:null,k=m&&o(g,.45),R=y&&o(S,.45),F=k?x(g,c,e):null,Y=R?x(S,h,t):null,P=k?x(c,g,d):null,q=R?x(h,S,n):null;return{aL:L,aR:M,shHipYL:l,shHipYR:a,armTorsoL:f,armTorsoR:v,shWrXL:E,shWrXR:b,khsAngleL:F,khsAngleR:Y,hkaAngleL:P,hkaAngleR:q}},_effectiveAngle(s){const{aL:e,aR:t}=this._poseMetrics(s);return e==null?t:t==null?e:(e+t)/2},canStart(s){const{aL:e,aR:t,shHipYL:i,shHipYR:r,armTorsoL:c,armTorsoR:h,shWrXL:p,shWrXR:u,khsAngleL:d,khsAngleR:n}=this._poseMetrics(s),g=e==null?t:t==null?e:(e+t)/2,S=i==null?r:r==null?i:(i+r)/2,m=c==null?h:h==null?c:(c+h)/2,y=p==null?u:u==null?p:(p+u)/2,L=d==null?n:n==null?d:(d+n)/2;if(console.log(`[${this.name}] canStart check:`,{ang:g==null?void 0:g.toFixed(1),yDiff:S==null?void 0:S.toFixed(3),armTorso:m==null?void 0:m.toFixed(1),shWrX:y==null?void 0:y.toFixed(3),khsAngle:L==null?void 0:L.toFixed(1),thresholds:{straightStartDeg:this.straightStartDeg,shHipYStartMax:this.shHipYStartMax,armTorsoMaxDeg:this.armTorsoMaxDeg,shWrXStartMin:this.shWrXStartMin}}),g==null||S==null||m==null)return console.log(`[${this.name}] âŒ canStart -> false (missing: ang=${g}, yDiff=${S}, armTorso=${m})`),!1;if(m>this.armTorsoMaxDeg)return console.log(`[${this.name}] âŒ canStart -> false (armTorso ${m.toFixed(1)}Â° > ${this.armTorsoMaxDeg}Â°)`),!1;if(this.requireShouldersAheadOfWrists&&(y==null||y<this.shWrXStartMin))return console.log(`[${this.name}] âŒ canStart -> false (shWrX ${y==null?void 0:y.toFixed(3)} < ${this.shWrXStartMin})`),!1;if(this.name==="Adv. tuck planche"&&(L==null||L<82))return console.log(`[${this.name}] âŒ canStart -> false (khsAngle ${L==null?void 0:L.toFixed(1)}Â° < 82Â°)`),!1;const M=this.straightStartDeg==null?!0:g>=this.straightStartDeg-this.hysteresisDeg,l=S<=this.shHipYStartMax;return M||console.log(`[${this.name}] âŒ canStart -> false (angle ${g.toFixed(1)}Â° < ${this.straightStartDeg-this.hysteresisDeg}Â°)`),l||console.log(`[${this.name}] âŒ canStart -> false (yDiff ${S.toFixed(3)} > ${this.shHipYStartMax})`),M&&l&&console.log(`[${this.name}] âœ… canStart -> TRUE!`),M&&l},canComplete(s){const{aL:e,aR:t,shHipYL:i,shHipYR:r,shWrXL:c,shWrXR:h,hkaAngleL:p,hkaAngleR:u}=this._poseMetrics(s),d=e==null?t:t==null?e:(e+t)/2,n=i==null?r:r==null?i:(i+r)/2,g=c==null?h:h==null?c:(c+h)/2,S=p==null?u:u==null?p:(p+u)/2;return d==null||n==null?!0:(this.name==="Full planche"||this.name==="Straddle planche"||this.name==="Planche lean")&&S!=null&&S<this.hkaAngleMinStop?(console.log(`VideoAnalyzer canComplete -> true (jambes pliÃ©es: hkaAngle ${S}Â° < ${this.hkaAngleMinStop}Â°)`),!0):!!(this.requireShouldersAheadOfWrists&&(g==null||g<this.shWrXStopMin)||this.straightStopDeg!=null&&d<=this.straightStopDeg+this.hysteresisDeg||n>=this.shHipYStopMax)},getAscentSignal(s){const e=s[11],t=s[12];return!o(e,.35)||!o(t,.35)?null:(e.y+t.y)/2}}}function B(H,s={}){return{name:H,mode:"hold",tracking:"timer",initState:"off",activeState:"on",idleEndState:"off",requiredVisibility:.45,armTorsoMaxDeg:135,shHipYMax:.08,hipAnkleYMax:.12,hysteresisDeg:2,sidePolicy:"either",_poseMetrics(e){const t=e[11],i=e[12],r=e[13],c=e[14],h=e[23],p=e[24],u=e[25],d=e[26],n=e[27],g=e[28],S=o(t,this.requiredVisibility)&&o(r,this.requiredVisibility)&&o(h,this.requiredVisibility)&&o(n,this.requiredVisibility),m=o(i,this.requiredVisibility)&&o(c,this.requiredVisibility)&&o(p,this.requiredVisibility)&&o(g,this.requiredVisibility),y=S?x(r,t,h):null,L=m?x(c,i,p):null,M=S?Math.abs(t.y-h.y):null,l=m?Math.abs(i.y-p.y):null,a=S?Math.abs(h.y-n.y):null,f=m?Math.abs(p.y-g.y):null,v=S&&o(u,this.requiredVisibility)?x(h,u,n):null,E=m&&o(d,this.requiredVisibility)?x(p,d,g):null;return{armTorsoL:y,armTorsoR:L,shHipYL:M,shHipYR:l,hipAnkYL:a,hipAnkYR:f,hkaAngleL:v,hkaAngleR:E}},_avg(e,t){return e==null?t:t==null?e:(e+t)/2},canStart(e){const{armTorsoL:t,armTorsoR:i,shHipYL:r,shHipYR:c,hipAnkYL:h,hipAnkYR:p}=this._poseMetrics(e),u=this._avg(t,i),d=this._avg(r,c),n=this._avg(h,p);return!(u==null||d==null||n==null||u>this.armTorsoMaxDeg+this.hysteresisDeg||d>this.shHipYMax||n>this.hipAnkleYMax)},canComplete(e){const{armTorsoL:t,armTorsoR:i,shHipYL:r,shHipYR:c,hipAnkYL:h,hipAnkYR:p}=this._poseMetrics(e),u=this._avg(t,i),d=this._avg(r,c),n=this._avg(h,p);return u==null||d==null||n==null||u>this.armTorsoMaxDeg+this.hysteresisDeg||d>this.shHipYMax||n>this.hipAnkleYMax},getAscentSignal(e){const t=e[11],i=e[12];return!o(t,.35)||!o(i,.35)?null:(t.y+i.y)/2},_elbowAngles(e){const t=e[11],i=e[12],r=e[13],c=e[14],h=e[15],p=e[16],u=o(t,this.requiredVisibility)&&o(r,this.requiredVisibility)&&o(h,this.requiredVisibility),d=o(i,this.requiredVisibility)&&o(c,this.requiredVisibility)&&o(p,this.requiredVisibility),n=u?x(t,r,h):null,g=d?x(i,c,p):null;return n==null&&g==null?null:n==null?g:g==null?n:(n+g)/2},_bodyAlignment(e){const t=e[11],i=e[12],r=e[23],c=e[24],h=e[27],p=e[28],u=o(t,this.requiredVisibility)&&o(i,this.requiredVisibility),d=o(r,this.requiredVisibility)&&o(c,this.requiredVisibility),n=o(h,this.requiredVisibility)&&o(p,this.requiredVisibility);if(!u||!d||!n)return null;const g={x:(t.x+i.x)/2,y:(t.y+i.y)/2,z:((t.z??0)+(i.z??0))/2},S={x:(r.x+c.x)/2,y:(r.y+c.y)/2,z:((r.z??0)+(c.z??0))/2},m={x:(h.x+p.x)/2,y:(h.y+p.y)/2,z:((h.z??0)+(p.z??0))/2};return x(g,S,m)},...s}}function J(H,s={}){return{name:H,mode:"hold",tracking:"timer",initState:"off",activeState:"on",idleEndState:"off",requiredVisibility:.45,straightStartDeg:155,straightStopDeg:135,hysteresisDeg:3,shHipYMax:.08,hipAnkleYMax:.1,armTorsoMaxDeg:140,sidePolicy:"either",_poseMetrics(e){const t=e[11],i=e[12],r=e[13],c=e[14],h=e[23],p=e[24],u=e[27],d=e[28],n=o(t,this.requiredVisibility)&&o(r,this.requiredVisibility)&&o(h,this.requiredVisibility)&&o(u,this.requiredVisibility),g=o(i,this.requiredVisibility)&&o(c,this.requiredVisibility)&&o(p,this.requiredVisibility)&&o(d,this.requiredVisibility),S=n?x(t,h,u):null,m=g?x(i,p,d):null,y=n?x(r,t,h):null,L=g?x(c,i,p):null,M=n?Math.abs(t.y-h.y):null,l=g?Math.abs(i.y-p.y):null,a=n?Math.abs(h.y-u.y):null,f=g?Math.abs(p.y-d.y):null;return{straightL:S,straightR:m,armTorsoL:y,armTorsoR:L,shHipYL:M,shHipYR:l,hipAnkYL:a,hipAnkYR:f}},_avg(e,t){return e==null?t:t==null?e:(e+t)/2},canStart(e){const t=this._poseMetrics(e),i=this._avg(t.straightL,t.straightR),r=this._avg(t.armTorsoL,t.armTorsoR),c=this._avg(t.shHipYL,t.shHipYR),h=this._avg(t.hipAnkYL,t.hipAnkYR);return i==null||r==null||c==null||h==null||r>this.armTorsoMaxDeg?!1:i>=this.straightStartDeg-this.hysteresisDeg&&c<=this.shHipYMax&&h<=this.hipAnkleYMax},canComplete(e){const t=this._poseMetrics(e),i=this._avg(t.straightL,t.straightR),r=this._avg(t.shHipYL,t.shHipYR),c=this._avg(t.hipAnkYL,t.hipAnkYR);return i==null||r==null||c==null||i<=this.straightStopDeg+this.hysteresisDeg||r>this.shHipYMax||c>this.hipAnkleYMax},getAscentSignal(e){const t=e[11],i=e[12];return!o(t,.35)||!o(i,.35)?null:(t.y+i.y)/2},_effectiveAngle(e){const t=this._poseMetrics(e);return this._avg(t.straightL,t.straightR)},...s}}function I(){return{Tractions:G,Pompes:Q,Handstand:j,"Handstand Push Up":N,"90 Degree HSPU":K,Dips:U,"Front Lever Raises":O,"Straddle planche":w({...D("Straddle planche"),name:"Straddle planche"}),"Full planche":w({...D("Full planche"),name:"Full planche",straightStartDeg:129,straightStopDeg:125,shHipYStartMax:.28,shHipYStopMax:.3,shWrXStartMin:.2,shWrXStopMin:.19,armTorsoMaxDeg:120}),"Tuck planche":w({...D("Tuck planche"),name:"Tuck planche",straightStartDeg:null,straightStopDeg:null,shHipYStartMax:.11,shHipYStopMax:.09,shWrXStartMin:.06,shWrXStopMin:.05}),"Adv. tuck planche":w({...D("Adv. tuck planche"),name:"Adv. tuck planche",straightStartDeg:null,straightStopDeg:null,shHipYStartMax:.11,shHipYStopMax:.09,shWrXStartMin:.06,shWrXStopMin:.05}),"Planche lean":w({...D("Planche lean"),name:"Planche lean",shHipYStartMax:.09,shHipYStopMax:.1}),"Front Lever":B("Front Lever",{armTorsoMaxDeg:100}),"Tuck Front Lever":B("Tuck Front Lever",{armTorsoMaxDeg:145}),"Straddle Front Lever":B("Straddle Front Lever",{armTorsoMaxDeg:140}),"Human Flag":J("Human Flag")}}class Z{constructor(){this.videoElement=document.getElementById("videoElement"),this.canvasElement=document.getElementById("canvasElement"),this.ctx=this.canvasElement.getContext("2d"),this.poseLandmarker=null,this.exercise=null,this.EXERCISES=I(),this.isAnalyzing=!1,this.repState=null,this.repStarted=!1,this.stateFrameCount=0,this.consecutiveFramesRequired=2,this.currentSetReps=0,this.holdStartTime=null,this.currentSetDisplay=null,this.qualitySamples=[],this.leanScoreSamples=[],this.trunkScoreSamples=[],this.alignmentScoreSamples=[],this.kneeHipShoulderScoreSamples=[],this.straightLegsScoreSamples=[],this.verticalityScoreSamples=[],this.elbowDepthScoreSamples=[],this.alignmentAngleSamples=[],this.verticalityAngleSamples=[],this.frontLeverElbowScoreSamples=[],this.frontLeverAlignmentScoreSamples=[],this.frontLeverElbowAngleSamples=[],this.frontLeverAlignmentAngleSamples=[],this.setupUI(),this.initializePoseTracking()}setupUI(){const s=document.getElementById("videoFile"),e=document.getElementById("analyzeBtn"),t=document.getElementById("restartBtn"),i=document.getElementById("reanalyzeBtn");s.addEventListener("change",r=>{if(r.target.files.length>0){e.disabled=!1;const c=r.target.files[0],h=URL.createObjectURL(c);this.videoElement.src=h,this.videoElement.load()}}),e.addEventListener("click",()=>this.startAnalysis()),i.addEventListener("click",()=>this.reanalyze()),t.addEventListener("click",()=>this.restart())}async initializePoseTracking(){try{const s=await _.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm");this.poseLandmarker=await C.createFromOptions(s,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",delegate:"GPU"},runningMode:"VIDEO",numPoses:1}),console.log("âœ… PoseLandmarker initialized")}catch(s){console.error("âŒ Failed to initialize PoseLandmarker:",s),this.showStatus("Erreur d'initialisation de la dÃ©tection de pose","error")}}async startAnalysis(){const s=document.getElementById("exerciseSelect").value;if(this.EXERCISES=I(),this.exercise=this.EXERCISES[s],!this.exercise){this.showStatus("Exercice non reconnu","error");return}if(!this.poseLandmarker){this.showStatus("DÃ©tection de pose non initialisÃ©e","error");return}this.repState=this.exercise.initState,this.repStarted=!1,this.stateFrameCount=0,this.currentSetReps=0,this.holdStartTime=null,this.currentSetDisplay=null,this.holdCompleted=!1,this.exercise.name==="90 Degree HSPU"&&(this.exercise.hasReachedInvertedLock=!1),this.exercise.name==="Handstand Push Up"&&(this.exercise.hasReachedTopPosition=!1),this.qualitySamples=[],this.leanScoreSamples=[],this.trunkScoreSamples=[],this.alignmentScoreSamples=[],this.kneeHipShoulderScoreSamples=[],this.straightLegsScoreSamples=[],this.verticalityScoreSamples=[],this.elbowDepthScoreSamples=[],this.alignmentAngleSamples=[],this.verticalityAngleSamples=[],this.frontLeverElbowScoreSamples=[],this.frontLeverAlignmentScoreSamples=[],this.frontLeverElbowAngleSamples=[],this.frontLeverAlignmentAngleSamples=[],this.shHipYSamples=[],this.shWrXSamples=[],this.hkaAngleSamples=[],this.khsAngleSamples=[],this.elbowAngleSamples=[],this.currentRepElbowAngles=[],document.getElementById("uploadSection").style.display="none",document.getElementById("videoPreview").classList.add("active"),document.getElementById("progressBar").classList.add("active"),document.getElementById("results").classList.remove("active"),this.showStatus("Analyse en cours...","processing"),this.isAnalyzing=!0,this.videoElement.addEventListener("loadedmetadata",()=>{this.canvasElement.width=this.videoElement.videoWidth,this.canvasElement.height=this.videoElement.videoHeight},{once:!0}),await this.videoElement.play(),this.processVideo()}async processVideo(){const s=async()=>{if(!this.isAnalyzing||this.videoElement.paused||this.videoElement.ended){this.videoElement.ended&&this.finalizeAnalysis();return}const e=this.videoElement.currentTime/this.videoElement.duration*100;document.getElementById("progressFill").style.width=`${e}%`,document.getElementById("progressFill").textContent=`${Math.round(e)}%`;const t=this.poseLandmarker.detectForVideo(this.videoElement,performance.now());if(this.ctx.clearRect(0,0,this.canvasElement.width,this.canvasElement.height),t.landmarks&&t.landmarks.length>0){const i=t.landmarks[0];this.drawLandmarks(i),this.trackMovement(i),this.sampleQuality(i)}requestAnimationFrame(s)};s()}trackMovement(s){if(!(!s||!this.exercise)){if(this.exercise.tracking==="timer"||this.exercise.mode==="hold"){this.trackTimer(s);return}if(this.repState===this.exercise.initState)!this.repStarted&&this.exercise.canStart(s)?(this.stateFrameCount++,this.stateFrameCount>=this.consecutiveFramesRequired&&(this.repState=this.exercise.activeState,this.repStarted=!0,this.stateFrameCount=0,(this.exercise.name==="Handstand Push Up"||this.exercise.name==="90 Degree HSPU")&&console.log(`ðŸ”½ [${this.exercise.name}] repState change: initState â†’ activeState (descente commencÃ©e) | currentReps: ${this.currentSetReps}`))):this.stateFrameCount=0;else if(this.repState===this.exercise.activeState)if(this.repStarted&&this.exercise.canComplete(s)){if(this.stateFrameCount++,this.stateFrameCount>=this.consecutiveFramesRequired){if(this.repState=this.exercise.initState,this.currentSetReps++,(this.exercise.name==="Handstand Push Up"||this.exercise.name==="90 Degree HSPU")&&(console.log(`ðŸ”¼ [${this.exercise.name}] repState change: activeState â†’ initState (montÃ©e complÃ©tÃ©e)`),console.log(`âœ… [${this.exercise.name}] REP #${this.currentSetReps} COMPTÃ‰E !`)),(this.exercise.name==="Handstand Push Up"||this.exercise.name==="90 Degree HSPU")&&this.currentRepElbowAngles.length>0){const e=Math.min(...this.currentRepElbowAngles);this.elbowAngleSamples.push(e);const t=W(e);this.elbowDepthScoreSamples.push(t),console.log(`ðŸ“Š [${this.exercise.name}] Rep ${this.currentSetReps} - Min angle: ${e.toFixed(1)}Â° â†’ Score: ${t}/10`),this.currentRepElbowAngles=[]}this.stateFrameCount=0,this.repStarted=!1}}else this.stateFrameCount=0}}trackTimer(s){if(!this.holdCompleted){if(this.repState===this.exercise.initState)!this.repStarted&&this.exercise.canStart(s)?(this.stateFrameCount++,this.stateFrameCount>=this.consecutiveFramesRequired&&(this.repState=this.exercise.activeState,this.repStarted=!0,this.stateFrameCount=0,this.holdStartTime=this.videoElement.currentTime,this.currentSetReps=0,console.log(`ðŸŸ¢ Hold START at ${this.holdStartTime.toFixed(2)}s`))):this.stateFrameCount=0;else if(this.repState===this.exercise.activeState){if(this.holdStartTime!=null){const e=Math.max(0,this.videoElement.currentTime-this.holdStartTime),t=Math.floor(e);t!==this.currentSetReps&&(this.currentSetReps=t),this.currentSetDisplay=Math.round(e*10)/10}if(this.repStarted&&this.exercise.canComplete(s)){if(this.stateFrameCount++,this.stateFrameCount>=this.consecutiveFramesRequired){const e=this.videoElement.currentTime;if(this.repState=this.exercise.initState,this.stateFrameCount=0,this.repStarted=!1,this.holdStartTime!=null){const t=Math.max(0,e-this.holdStartTime);this.currentSetReps=Math.max(this.currentSetReps,Math.floor(t)),console.log(`ðŸ”´ Hold STOP at ${e.toFixed(2)}s (duration: ${t.toFixed(2)}s)`),this.holdCompleted=!0}}}else this.stateFrameCount=0}}}sampleQuality(s){var i,r,c,h,p,u,d,n,g,S,m,y,L,M;if(!this.exercise||this.repState!==this.exercise.activeState)return;let e=null;const t=this.exercise.name||"";if(t.toLowerCase().includes("planche")){const l=X(s,this.exercise);e=l==null?void 0:l.avgScore,(l==null?void 0:l.leanScore)!=null&&this.leanScoreSamples.push(l.leanScore),(l==null?void 0:l.trunkScore)!=null&&this.trunkScoreSamples.push(l.trunkScore),(l==null?void 0:l.alignmentScore)!=null&&this.alignmentScoreSamples.push(l.alignmentScore),(l==null?void 0:l.kneeHipShoulderScore)!=null&&this.kneeHipShoulderScoreSamples.push(l.kneeHipShoulderScore),(l==null?void 0:l.straightLegsScore)!=null&&this.straightLegsScoreSamples.push(l.straightLegsScore);const a=(r=(i=this.exercise)._poseMetrics)==null?void 0:r.call(i,s);if(a){const f=a.aL==null?a.aR:a.aR==null?a.aL:(a.aL+a.aR)/2,v=a.shHipYL==null?a.shHipYR:a.shHipYR==null?a.shHipYL:(a.shHipYL+a.shHipYR)/2,E=a.shWrXL==null?a.shWrXR:a.shWrXR==null?a.shWrXL:(a.shWrXL+a.shWrXR)/2,b=a.hkaAngleL==null?a.hkaAngleR:a.hkaAngleR==null?a.hkaAngleL:(a.hkaAngleL+a.hkaAngleR)/2,k=a.khsAngleL==null?a.khsAngleR:a.khsAngleR==null?a.khsAngleL:(a.khsAngleL+a.khsAngleR)/2;f!=null&&this.alignmentAngleSamples.push(f),v!=null&&this.shHipYSamples.push(v),E!=null&&this.shWrXSamples.push(E),b!=null&&this.hkaAngleSamples.push(b),k!=null&&this.khsAngleSamples.push(k)}}else if(t==="Front Lever"||t==="Front Lever Raises"||t==="Tuck Front Lever"||t==="Straddle Front Lever"){let l=null,a=null;const f=(h=(c=this.exercise)._elbowAngles)==null?void 0:h.call(c,s);f!=null&&(l=T(f,124),l!=null&&this.frontLeverElbowScoreSamples.push(l),this.frontLeverElbowAngleSamples.push(f));const v=(u=(p=this.exercise)._bodyAlignment)==null?void 0:u.call(p,s);v!=null&&(a=T(v,175,$),a!=null&&this.frontLeverAlignmentScoreSamples.push(a),this.frontLeverAlignmentAngleSamples.push(v)),l!=null&&a!=null?e=(l+a)/2:l!=null?e=l:a!=null&&(e=a)}else if(this.exercise.mode==="hold"&&typeof this.exercise._effectiveAngle=="function"){const l=this.exercise._effectiveAngle(s);if(e=T(l,160),e!=null&&this.alignmentScoreSamples.push(e),l!=null&&this.alignmentAngleSamples.push(l),t==="Human Flag"&&console.log(`[Human Flag] angle: ${l==null?void 0:l.toFixed(1)}Â°, score: ${e==null?void 0:e.toFixed(1)}`),t==="Handstand"){const a=s[11],f=s[12],v=s[27],E=s[28],b=o(a,.4)&&o(v,.4),k=o(f,.4)&&o(E,.4),R=b&&k?{x:(a.x+f.x)/2,y:(a.y+f.y)/2}:b?a:k?f:null,F=b&&k?{x:(v.x+E.x)/2,y:(v.y+E.y)/2}:b?v:k?E:null;if(R&&F){const Y=z(R,F,$);if(Y!=null){this.verticalityScoreSamples.push(Y);const P=F.x-R.x,q=F.y-R.y,V=Math.atan2(Math.abs(P),Math.abs(q))*180/Math.PI;this.verticalityAngleSamples.push(V)}}}}else if(t==="Handstand Push Up"){const l=(n=(d=this.exercise)._elbowAngles)==null?void 0:n.call(d,s),a=this.repState===this.exercise.initState?"ðŸ”¼":"ðŸ”½";console.log(`${a} [HSPU Frame] State: ${this.repState} | Angle coude: ${l==null?void 0:l.toFixed(1)}Â° | Frames: ${this.stateFrameCount}/${this.consecutiveFramesRequired}`);const f=(S=(g=this.exercise)._bodyAlignment)==null?void 0:S.call(g,s),v=T(f,180,$);this.repState===this.exercise.activeState&&l!=null&&this.currentRepElbowAngles.push(l),v!=null&&(this.alignmentScoreSamples.push(v),f!=null&&this.alignmentAngleSamples.push(f)),e=null}else if(t==="90 Degree HSPU"){const l=(y=(m=this.exercise)._poseMetrics)==null?void 0:y.call(m,s),a=l?l.elbowL??l.elbowR:null,f=(M=(L=this.exercise)._bodyAlignment)==null?void 0:M.call(L,s),v=T(f,180,$);this.repState===this.exercise.activeState&&a!=null&&this.currentRepElbowAngles.push(a),v!=null&&(this.alignmentScoreSamples.push(v),f!=null&&this.alignmentAngleSamples.push(f)),e=null}e!=null&&this.qualitySamples.push(e)}drawLandmarks(s){const e=[[11,12],[11,23],[12,24],[23,24],[11,13],[13,15],[12,14],[14,16],[23,25],[25,27],[24,26],[26,28]];this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=3,e.forEach(([i,r])=>{const c=s[i],h=s[r];c&&h&&o(c,.3)&&o(h,.3)&&(this.ctx.beginPath(),this.ctx.moveTo(c.x*this.canvasElement.width,c.y*this.canvasElement.height),this.ctx.lineTo(h.x*this.canvasElement.width,h.y*this.canvasElement.height),this.ctx.stroke())}),this.ctx.fillStyle="#ff0000",[0,11,12,13,14,15,16,23,24,25,26,27,28].forEach(i=>{const r=s[i];r&&o(r,.3)&&(this.ctx.beginPath(),this.ctx.arc(r.x*this.canvasElement.width,r.y*this.canvasElement.height,5,0,2*Math.PI),this.ctx.fill())})}finalizeAnalysis(){this.isAnalyzing=!1,this.videoElement.pause();const s={leanScore:this.leanScoreSamples.length>0?Math.round(A(this.leanScoreSamples)*10)/10:null,trunkScore:this.trunkScoreSamples.length>0?Math.round(A(this.trunkScoreSamples)*10)/10:null,alignmentScore:this.alignmentScoreSamples.length>0?Math.round(A(this.alignmentScoreSamples)*10)/10:null,kneeHipShoulderScore:this.kneeHipShoulderScoreSamples.length>0?Math.round(A(this.kneeHipShoulderScoreSamples)*10)/10:null,straightLegsScore:this.straightLegsScoreSamples.length>0?Math.round(A(this.straightLegsScoreSamples)*10)/10:null,verticalityScore:this.verticalityScoreSamples.length>0?Math.round(A(this.verticalityScoreSamples)*10)/10:null,elbowDepthScore:this.elbowDepthScoreSamples.length>0?Math.round(A(this.elbowDepthScoreSamples)*10)/10:null,alignmentAngle:this.alignmentAngleSamples.length>0?Math.round(A(this.alignmentAngleSamples)*10)/10:null,verticalityAngle:this.verticalityAngleSamples.length>0?Math.round(A(this.verticalityAngleSamples)*10)/10:null,frontLeverElbowScore:this.frontLeverElbowScoreSamples.length>0?Math.round(A(this.frontLeverElbowScoreSamples)*10)/10:null,frontLeverAlignmentScore:this.frontLeverAlignmentScoreSamples.length>0?Math.round(A(this.frontLeverAlignmentScoreSamples)*10)/10:null,frontLeverElbowAngle:this.frontLeverElbowAngleSamples.length>0?Math.round(A(this.frontLeverElbowAngleSamples)*10)/10:null,frontLeverAlignmentAngle:this.frontLeverAlignmentAngleSamples.length>0?Math.round(A(this.frontLeverAlignmentAngleSamples)*10)/10:null,shHipY:this.shHipYSamples.length>0?Math.round(A(this.shHipYSamples)*1e3)/1e3:null,shWrX:this.shWrXSamples.length>0?Math.round(A(this.shWrXSamples)*1e3)/1e3:null,hkaAngle:this.hkaAngleSamples.length>0?Math.round(A(this.hkaAngleSamples)*10)/10:null,khsAngle:this.khsAngleSamples.length>0?Math.round(A(this.khsAngleSamples)*10)/10:null,elbowAngle:this.elbowAngleSamples.length>0?Math.round(A(this.elbowAngleSamples)*10)/10:null};let e=null;if((this.exercise.name==="Handstand Push Up"||this.exercise.name==="90 Degree HSPU")&&s.elbowDepthScore!=null&&s.alignmentScore!=null)e=Math.round((s.elbowDepthScore+s.alignmentScore)/2*10)/10,console.log(`[VA] Score global calculÃ©: (${s.elbowDepthScore} + ${s.alignmentScore}) / 2 = ${e}`);else if(this.qualitySamples.length>0){const t=this.qualitySamples.length>3?this.qualitySamples.slice(0,-3):this.qualitySamples,i=A(t);e=i!=null?Math.round(i*10)/10:null}this.displayResults(e,s)}displayResults(s,e){document.getElementById("progressBar").classList.remove("active"),document.getElementById("status").classList.remove("active"),document.getElementById("results").classList.add("active"),document.getElementById("resultExerciseName").textContent=this.exercise.name;const t=this.exercise.tracking==="timer"||this.exercise.mode==="hold";if(document.getElementById("resultLabel").textContent=t?"DurÃ©e du hold":"RÃ©pÃ©titions",document.getElementById("resultValue").textContent=t?`${this.currentSetDisplay||this.currentSetReps}s`:this.currentSetReps,s!=null){const i=document.getElementById("qualityScoreSection");i.style.display="block";const r=document.getElementById("qualityScoreValue");r.textContent=`${s}/10`,r.classList.remove("excellent","good","poor"),s>=9?r.classList.add("excellent"):s>=7?r.classList.add("good"):r.classList.add("poor"),this.displayQualityDetails(e)}else document.getElementById("qualityScoreSection").style.display="none"}displayQualityDetails(s){const e=document.getElementById("qualityDetails");e.innerHTML="";const t=this.exercise.name,i=t==="Handstand",r=t==="Handstand Push Up",c=t==="90 Degree HSPU",h=t==="Adv. tuck planche",p=t==="Straddle planche"||t==="Full planche"||t==="Planche lean"||t==="Front Lever",u=[];if(s.alignmentScore!=null&&!r&&!c){const n=s.alignmentAngle!=null?` (Moy: ${s.alignmentAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ“",name:i?"Alignement corps":"Alignement",score:s.alignmentScore,description:`${i?"Ã‰paules-hanches-chevilles droites":"Alignement Ã©paules-hanches-chevilles"}${n}`})}if(s.verticalityScore!=null&&i){const n=s.verticalityAngle!=null?` (Moy: ${s.verticalityAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ“",name:"VerticalitÃ©",score:s.verticalityScore,description:`Alignement par rapport Ã  la verticale${n}`})}if(s.leanScore!=null&&!i){const n=s.shWrX!=null?` (shWrX: ${s.shWrX.toFixed(3)})`:"";u.push({icon:"ðŸ’Ž",name:"Lean (avancÃ©e)",score:s.leanScore,description:`Position des Ã©paules par rapport aux poignets${n}`})}if(s.trunkScore!=null){const n=s.shHipY!=null?` (shHipY: ${s.shHipY.toFixed(3)})`:"";u.push({icon:"ðŸŽ¯",name:"Tronc",score:s.trunkScore,description:`Alignement du tronc${n}`})}if(s.kneeHipShoulderScore!=null&&h){const n=s.khsAngle!=null?` (Moy: ${s.khsAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ¦µ",name:"Genou-Hanche-Ã‰paule",score:s.kneeHipShoulderScore,description:`Alignement spÃ©cifique Advanced Tuck${n}`})}if(s.straightLegsScore!=null&&p){const n=s.hkaAngle!=null?` (Moy: ${s.hkaAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ¦µ",name:"Jambes tendues",score:s.straightLegsScore,description:`Extension des jambes${n}`})}const d=t==="Front Lever Raises"||t==="Tuck Front Lever"||t==="Straddle Front Lever";if(s.frontLeverElbowScore!=null&&d){const n=s.frontLeverElbowAngle!=null?` (Moy: ${s.frontLeverElbowAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ’ª",name:"Verrouillage des coudes",score:s.frontLeverElbowScore,description:`Extension complÃ¨te des bras${n}`})}if(s.frontLeverAlignmentScore!=null&&d){const n=s.frontLeverAlignmentAngle!=null?` (Moy: ${s.frontLeverAlignmentAngle.toFixed(1)}Â°)`:"";u.push({icon:"âš–ï¸",name:"Alignement horizontal",score:s.frontLeverAlignmentScore,description:`Ã‰paules-hanches-chevilles alignÃ©s${n}`})}if(s.elbowDepthScore!=null&&(r||c)){const n=s.elbowAngle!=null?` (Moy: ${s.elbowAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ’ª",name:"Profondeur coude",score:s.elbowDepthScore,description:`Angle du coude Ã  la descente${n}`})}if(s.alignmentScore!=null&&(r||c)){const n=s.alignmentAngle!=null?` (Moy: ${s.alignmentAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ“",name:"Alignement du corps",score:s.alignmentScore,description:`Ã‰paules-hanches-chevilles droites${n}`})}u.forEach(n=>{const g=document.createElement("div");g.className="quality-detail-item",g.innerHTML=`
        <div class="quality-detail-icon">${n.icon}</div>
        <div class="quality-detail-name">${n.name}</div>
        <div class="quality-detail-score">${n.score}/10</div>
        <div class="quality-detail-description">${n.description}</div>
      `,e.appendChild(g)})}showStatus(s,e){const t=document.getElementById("status");t.textContent=s,t.className=`status active ${e}`}reanalyze(){document.getElementById("results").classList.remove("active"),document.getElementById("progressBar").classList.remove("active"),document.getElementById("status").classList.remove("active"),this.isAnalyzing=!1,this.currentSetReps=0,this.currentSetDisplay=0,this.repState=null,this.repStarted=!1,this.stateFrameCount=0,this.holdStartTime=null,this.qualitySamples=[],this.leanScoreSamples=[],this.trunkScoreSamples=[],this.alignmentScoreSamples=[],this.kneeHipShoulderScoreSamples=[],this.straightLegsScoreSamples=[],this.verticalityScoreSamples=[],this.elbowDepthScoreSamples=[],this.alignmentAngleSamples=[],this.verticalityAngleSamples=[],this.videoElement.currentTime=0,this.videoElement.pause(),this.ctx.clearRect(0,0,this.canvasElement.width,this.canvasElement.height),this.startAnalysis()}restart(){document.getElementById("uploadSection").style.display="block",document.getElementById("videoPreview").classList.remove("active"),document.getElementById("results").classList.remove("active"),document.getElementById("progressBar").classList.remove("active"),document.getElementById("status").classList.remove("active"),document.getElementById("videoFile").value="",document.getElementById("analyzeBtn").disabled=!0,this.videoElement.src="",this.videoElement.load(),this.isAnalyzing=!1}}document.addEventListener("DOMContentLoaded",()=>{new Z});
