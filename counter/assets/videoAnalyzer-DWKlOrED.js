import"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";import{FilesetResolver as C,PoseLandmarker as _}from"https://esm.sh/@mediapipe/tasks-vision@0.10.14";import{d as W,s as X,v as o,b as z,a as D,c as A,F as O,D as U,N as K,H as N,f as Q,P as j,T as G,g as w,h as x}from"./exercises-bHxWPm0D.js";const T=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);function Y(H){return{...H,_poseMetrics(t){const e=t[11],s=t[12],i=t[13],l=t[14],c=t[23],h=t[24],p=t[15],u=t[16],d=t[27],n=t[28],g=t[25],S=t[26],m=o(e,.45)&&o(i,.45)&&o(c,.45)&&o(p,.45)&&o(d,.45),y=o(s,.45)&&o(l,.45)&&o(h,.45)&&o(u,.45)&&o(n,.45),L=m?x(e,c,d):null,E=y?x(s,h,n):null,r=m?Math.abs(e.y-c.y):null,a=y?Math.abs(s.y-h.y):null,f=m?x(i,e,c):null,v=y?x(l,s,h):null,M=m?e.x-p.x:null,b=y?s.x-u.x:null,k=m&&o(g,.45),R=y&&o(S,.45),F=k?x(g,c,e):null,$=R?x(S,h,s):null,P=k?x(c,g,d):null,q=R?x(h,S,n):null;return{aL:L,aR:E,shHipYL:r,shHipYR:a,armTorsoL:f,armTorsoR:v,shWrXL:M,shWrXR:b,khsAngleL:F,khsAngleR:$,hkaAngleL:P,hkaAngleR:q}},_effectiveAngle(t){const{aL:e,aR:s}=this._poseMetrics(t);return e==null?s:s==null?e:(e+s)/2},canStart(t){const{aL:e,aR:s,shHipYL:i,shHipYR:l,armTorsoL:c,armTorsoR:h,shWrXL:p,shWrXR:u,khsAngleL:d,khsAngleR:n}=this._poseMetrics(t),g=e==null?s:s==null?e:(e+s)/2,S=i==null?l:l==null?i:(i+l)/2,m=c==null?h:h==null?c:(c+h)/2,y=p==null?u:u==null?p:(p+u)/2,L=d==null?n:n==null?d:(d+n)/2;if(console.log(`[${this.name}] canStart check:`,{ang:g==null?void 0:g.toFixed(1),yDiff:S==null?void 0:S.toFixed(3),armTorso:m==null?void 0:m.toFixed(1),shWrX:y==null?void 0:y.toFixed(3),khsAngle:L==null?void 0:L.toFixed(1),thresholds:{straightStartDeg:this.straightStartDeg,shHipYStartMax:this.shHipYStartMax,armTorsoMaxDeg:this.armTorsoMaxDeg,shWrXStartMin:this.shWrXStartMin}}),g==null||S==null||m==null)return console.log(`[${this.name}] âŒ canStart -> false (missing: ang=${g}, yDiff=${S}, armTorso=${m})`),!1;if(m>this.armTorsoMaxDeg)return console.log(`[${this.name}] âŒ canStart -> false (armTorso ${m.toFixed(1)}Â° > ${this.armTorsoMaxDeg}Â°)`),!1;if(this.requireShouldersAheadOfWrists&&(y==null||y<this.shWrXStartMin))return console.log(`[${this.name}] âŒ canStart -> false (shWrX ${y==null?void 0:y.toFixed(3)} < ${this.shWrXStartMin})`),!1;if(this.name==="Adv. tuck planche"&&(L==null||L<82))return console.log(`[${this.name}] âŒ canStart -> false (khsAngle ${L==null?void 0:L.toFixed(1)}Â° < 82Â°)`),!1;const E=this.straightStartDeg==null?!0:g>=this.straightStartDeg-this.hysteresisDeg,r=S<=this.shHipYStartMax;return E||console.log(`[${this.name}] âŒ canStart -> false (angle ${g.toFixed(1)}Â° < ${this.straightStartDeg-this.hysteresisDeg}Â°)`),r||console.log(`[${this.name}] âŒ canStart -> false (yDiff ${S.toFixed(3)} > ${this.shHipYStartMax})`),E&&r&&console.log(`[${this.name}] âœ… canStart -> TRUE!`),E&&r},canComplete(t){const{aL:e,aR:s,shHipYL:i,shHipYR:l,shWrXL:c,shWrXR:h,hkaAngleL:p,hkaAngleR:u}=this._poseMetrics(t),d=e==null?s:s==null?e:(e+s)/2,n=i==null?l:l==null?i:(i+l)/2,g=c==null?h:h==null?c:(c+h)/2,S=p==null?u:u==null?p:(p+u)/2;return d==null||n==null?!0:(this.name==="Full planche"||this.name==="Straddle planche"||this.name==="Planche lean")&&S!=null&&S<this.hkaAngleMinStop?(console.log(`VideoAnalyzer canComplete -> true (jambes pliÃ©es: hkaAngle ${S}Â° < ${this.hkaAngleMinStop}Â°)`),!0):!!(this.requireShouldersAheadOfWrists&&(g==null||g<this.shWrXStopMin)||this.straightStopDeg!=null&&d<=this.straightStopDeg+this.hysteresisDeg||n>=this.shHipYStopMax)},getAscentSignal(t){const e=t[11],s=t[12];return!o(e,.35)||!o(s,.35)?null:(e.y+s.y)/2}}}function B(H,t={}){return{name:H,mode:"hold",tracking:"timer",initState:"off",activeState:"on",idleEndState:"off",requiredVisibility:.45,armTorsoMaxDeg:135,shHipYMax:.08,hipAnkleYMax:.12,hysteresisDeg:2,sidePolicy:"either",_poseMetrics(e){const s=e[11],i=e[12],l=e[13],c=e[14],h=e[23],p=e[24],u=e[25],d=e[26],n=e[27],g=e[28],S=o(s,this.requiredVisibility)&&o(l,this.requiredVisibility)&&o(h,this.requiredVisibility)&&o(n,this.requiredVisibility),m=o(i,this.requiredVisibility)&&o(c,this.requiredVisibility)&&o(p,this.requiredVisibility)&&o(g,this.requiredVisibility),y=S?x(l,s,h):null,L=m?x(c,i,p):null,E=S?Math.abs(s.y-h.y):null,r=m?Math.abs(i.y-p.y):null,a=S?Math.abs(h.y-n.y):null,f=m?Math.abs(p.y-g.y):null,v=S&&o(u,this.requiredVisibility)?x(h,u,n):null,M=m&&o(d,this.requiredVisibility)?x(p,d,g):null;return{armTorsoL:y,armTorsoR:L,shHipYL:E,shHipYR:r,hipAnkYL:a,hipAnkYR:f,hkaAngleL:v,hkaAngleR:M}},_avg(e,s){return e==null?s:s==null?e:(e+s)/2},canStart(e){const{armTorsoL:s,armTorsoR:i,shHipYL:l,shHipYR:c,hipAnkYL:h,hipAnkYR:p}=this._poseMetrics(e),u=this._avg(s,i),d=this._avg(l,c),n=this._avg(h,p);return!(u==null||d==null||n==null||u>this.armTorsoMaxDeg+this.hysteresisDeg||d>this.shHipYMax||n>this.hipAnkleYMax)},canComplete(e){const{armTorsoL:s,armTorsoR:i,shHipYL:l,shHipYR:c,hipAnkYL:h,hipAnkYR:p}=this._poseMetrics(e),u=this._avg(s,i),d=this._avg(l,c),n=this._avg(h,p);return u==null||d==null||n==null||u>this.armTorsoMaxDeg+this.hysteresisDeg||d>this.shHipYMax||n>this.hipAnkleYMax},getAscentSignal(e){const s=e[11],i=e[12];return!o(s,.35)||!o(i,.35)?null:(s.y+i.y)/2},_elbowAngles(e){const s=e[11],i=e[12],l=e[13],c=e[14],h=e[15],p=e[16],u=o(s,this.requiredVisibility)&&o(l,this.requiredVisibility)&&o(h,this.requiredVisibility),d=o(i,this.requiredVisibility)&&o(c,this.requiredVisibility)&&o(p,this.requiredVisibility),n=u?x(s,l,h):null,g=d?x(i,c,p):null;return n==null&&g==null?null:n==null?g:g==null?n:(n+g)/2},_bodyAlignment(e){const s=e[11],i=e[12],l=e[23],c=e[24],h=e[27],p=e[28],u=o(s,this.requiredVisibility)&&o(i,this.requiredVisibility),d=o(l,this.requiredVisibility)&&o(c,this.requiredVisibility),n=o(h,this.requiredVisibility)&&o(p,this.requiredVisibility);if(!u||!d||!n)return null;const g={x:(s.x+i.x)/2,y:(s.y+i.y)/2,z:((s.z??0)+(i.z??0))/2},S={x:(l.x+c.x)/2,y:(l.y+c.y)/2,z:((l.z??0)+(c.z??0))/2},m={x:(h.x+p.x)/2,y:(h.y+p.y)/2,z:((h.z??0)+(p.z??0))/2};return x(g,S,m)},...t}}function J(H,t={}){return{name:H,mode:"hold",tracking:"timer",initState:"off",activeState:"on",idleEndState:"off",requiredVisibility:.45,straightStartDeg:155,straightStopDeg:135,hysteresisDeg:3,shHipYMax:.08,hipAnkleYMax:.1,armTorsoMaxDeg:140,sidePolicy:"either",_poseMetrics(e){const s=e[11],i=e[12],l=e[13],c=e[14],h=e[23],p=e[24],u=e[27],d=e[28],n=o(s,this.requiredVisibility)&&o(l,this.requiredVisibility)&&o(h,this.requiredVisibility)&&o(u,this.requiredVisibility),g=o(i,this.requiredVisibility)&&o(c,this.requiredVisibility)&&o(p,this.requiredVisibility)&&o(d,this.requiredVisibility),S=n?x(s,h,u):null,m=g?x(i,p,u):null,y=n?x(l,s,h):null,L=g?x(c,i,p):null,E=n?Math.abs(s.y-h.y):null,r=g?Math.abs(i.y-p.y):null,a=n?Math.abs(h.y-u.y):null,f=g?Math.abs(p.y-d.y):null;return{straightL:S,straightR:m,armTorsoL:y,armTorsoR:L,shHipYL:E,shHipYR:r,hipAnkYL:a,hipAnkYR:f}},_avg(e,s){return e==null?s:s==null?e:(e+s)/2},canStart(e){const s=this._poseMetrics(e),i=this._avg(s.straightL,s.straightR),l=this._avg(s.armTorsoL,s.armTorsoR),c=this._avg(s.shHipYL,s.shHipYR),h=this._avg(s.hipAnkYL,s.hipAnkYR);return i==null||l==null||c==null||h==null||l>this.armTorsoMaxDeg?!1:i>=this.straightStartDeg-this.hysteresisDeg&&c<=this.shHipYMax&&h<=this.hipAnkleYMax},canComplete(e){const s=this._poseMetrics(e),i=this._avg(s.straightL,s.straightR),l=this._avg(s.shHipYL,s.shHipYR),c=this._avg(s.hipAnkYL,s.hipAnkYR);return i==null||l==null||c==null||i<=this.straightStopDeg+this.hysteresisDeg||l>this.shHipYMax||c>this.hipAnkleYMax},getAscentSignal(e){const s=e[11],i=e[12];return!o(s,.35)||!o(i,.35)?null:(s.y+i.y)/2},...t}}function I(){return{Tractions:G,Pompes:j,Handstand:Q,"Handstand Push Up":N,"90 Degree HSPU":K,Dips:U,"Front Lever Raises":O,"Straddle planche":Y({...w("Straddle planche"),name:"Straddle planche"}),"Full planche":Y({...w("Full planche"),name:"Full planche",straightStartDeg:129,straightStopDeg:125,shHipYStartMax:.28,shHipYStopMax:.3,shWrXStartMin:.2,shWrXStopMin:.19,armTorsoMaxDeg:120}),"Tuck planche":Y({...w("Tuck planche"),name:"Tuck planche",straightStartDeg:null,straightStopDeg:null,shHipYStartMax:.11,shHipYStopMax:.09,shWrXStartMin:.06,shWrXStopMin:.05}),"Adv. tuck planche":Y({...w("Adv. tuck planche"),name:"Adv. tuck planche",straightStartDeg:null,straightStopDeg:null,shHipYStartMax:.11,shHipYStopMax:.09,shWrXStartMin:.06,shWrXStopMin:.05}),"Planche lean":Y({...w("Planche lean"),name:"Planche lean",shHipYStartMax:.09,shHipYStopMax:.1}),"Front Lever":B("Front Lever",{armTorsoMaxDeg:100}),"Tuck Front Lever":B("Tuck Front Lever",{armTorsoMaxDeg:145}),"Straddle Front Lever":B("Straddle Front Lever",{armTorsoMaxDeg:140}),"Human Flag":J("Human Flag")}}class Z{constructor(){this.videoElement=document.getElementById("videoElement"),this.canvasElement=document.getElementById("canvasElement"),this.ctx=this.canvasElement.getContext("2d"),this.poseLandmarker=null,this.exercise=null,this.EXERCISES=I(),this.isAnalyzing=!1,this.repState=null,this.repStarted=!1,this.stateFrameCount=0,this.consecutiveFramesRequired=2,this.currentSetReps=0,this.holdStartTime=null,this.currentSetDisplay=null,this.qualitySamples=[],this.leanScoreSamples=[],this.trunkScoreSamples=[],this.alignmentScoreSamples=[],this.kneeHipShoulderScoreSamples=[],this.straightLegsScoreSamples=[],this.verticalityScoreSamples=[],this.elbowDepthScoreSamples=[],this.alignmentAngleSamples=[],this.verticalityAngleSamples=[],this.frontLeverElbowScoreSamples=[],this.frontLeverAlignmentScoreSamples=[],this.frontLeverElbowAngleSamples=[],this.frontLeverAlignmentAngleSamples=[],this.setupUI(),this.initializePoseTracking()}setupUI(){const t=document.getElementById("videoFile"),e=document.getElementById("analyzeBtn"),s=document.getElementById("restartBtn"),i=document.getElementById("reanalyzeBtn");t.addEventListener("change",l=>{if(l.target.files.length>0){e.disabled=!1;const c=l.target.files[0],h=URL.createObjectURL(c);this.videoElement.src=h,this.videoElement.load()}}),e.addEventListener("click",()=>this.startAnalysis()),i.addEventListener("click",()=>this.reanalyze()),s.addEventListener("click",()=>this.restart())}async initializePoseTracking(){try{const t=await C.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm");this.poseLandmarker=await _.createFromOptions(t,{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",delegate:"GPU"},runningMode:"VIDEO",numPoses:1}),console.log("âœ… PoseLandmarker initialized")}catch(t){console.error("âŒ Failed to initialize PoseLandmarker:",t),this.showStatus("Erreur d'initialisation de la dÃ©tection de pose","error")}}async startAnalysis(){const t=document.getElementById("exerciseSelect").value;if(this.EXERCISES=I(),this.exercise=this.EXERCISES[t],!this.exercise){this.showStatus("Exercice non reconnu","error");return}if(!this.poseLandmarker){this.showStatus("DÃ©tection de pose non initialisÃ©e","error");return}this.repState=this.exercise.initState,this.repStarted=!1,this.stateFrameCount=0,this.currentSetReps=0,this.holdStartTime=null,this.currentSetDisplay=null,this.holdCompleted=!1,this.exercise.name==="90 Degree HSPU"&&(this.exercise.hasReachedInvertedLock=!1),this.exercise.name==="Handstand Push Up"&&(this.exercise.hasReachedTopPosition=!1),this.qualitySamples=[],this.leanScoreSamples=[],this.trunkScoreSamples=[],this.alignmentScoreSamples=[],this.kneeHipShoulderScoreSamples=[],this.straightLegsScoreSamples=[],this.verticalityScoreSamples=[],this.elbowDepthScoreSamples=[],this.alignmentAngleSamples=[],this.verticalityAngleSamples=[],this.frontLeverElbowScoreSamples=[],this.frontLeverAlignmentScoreSamples=[],this.frontLeverElbowAngleSamples=[],this.frontLeverAlignmentAngleSamples=[],this.shHipYSamples=[],this.shWrXSamples=[],this.hkaAngleSamples=[],this.khsAngleSamples=[],this.elbowAngleSamples=[],this.currentRepElbowAngles=[],document.getElementById("uploadSection").style.display="none",document.getElementById("videoPreview").classList.add("active"),document.getElementById("progressBar").classList.add("active"),document.getElementById("results").classList.remove("active"),this.showStatus("Analyse en cours...","processing"),this.isAnalyzing=!0,this.videoElement.addEventListener("loadedmetadata",()=>{this.canvasElement.width=this.videoElement.videoWidth,this.canvasElement.height=this.videoElement.videoHeight},{once:!0}),await this.videoElement.play(),this.processVideo()}async processVideo(){const t=async()=>{if(!this.isAnalyzing||this.videoElement.paused||this.videoElement.ended){this.videoElement.ended&&this.finalizeAnalysis();return}const e=this.videoElement.currentTime/this.videoElement.duration*100;document.getElementById("progressFill").style.width=`${e}%`,document.getElementById("progressFill").textContent=`${Math.round(e)}%`;const s=this.poseLandmarker.detectForVideo(this.videoElement,performance.now());if(this.ctx.clearRect(0,0,this.canvasElement.width,this.canvasElement.height),s.landmarks&&s.landmarks.length>0){const i=s.landmarks[0];this.drawLandmarks(i),this.trackMovement(i),this.sampleQuality(i)}requestAnimationFrame(t)};t()}trackMovement(t){if(!(!t||!this.exercise)){if(this.exercise.tracking==="timer"||this.exercise.mode==="hold"){this.trackTimer(t);return}if(this.repState===this.exercise.initState)!this.repStarted&&this.exercise.canStart(t)?(this.stateFrameCount++,this.stateFrameCount>=this.consecutiveFramesRequired&&(this.repState=this.exercise.activeState,this.repStarted=!0,this.stateFrameCount=0,(this.exercise.name==="Handstand Push Up"||this.exercise.name==="90 Degree HSPU")&&console.log(`ðŸ”½ [${this.exercise.name}] repState change: initState â†’ activeState (descente commencÃ©e) | currentReps: ${this.currentSetReps}`))):this.stateFrameCount=0;else if(this.repState===this.exercise.activeState)if(this.repStarted&&this.exercise.canComplete(t)){if(this.stateFrameCount++,this.stateFrameCount>=this.consecutiveFramesRequired){if(this.repState=this.exercise.initState,this.currentSetReps++,(this.exercise.name==="Handstand Push Up"||this.exercise.name==="90 Degree HSPU")&&(console.log(`ðŸ”¼ [${this.exercise.name}] repState change: activeState â†’ initState (montÃ©e complÃ©tÃ©e)`),console.log(`âœ… [${this.exercise.name}] REP #${this.currentSetReps} COMPTÃ‰E !`)),(this.exercise.name==="Handstand Push Up"||this.exercise.name==="90 Degree HSPU")&&this.currentRepElbowAngles.length>0){const e=Math.min(...this.currentRepElbowAngles);this.elbowAngleSamples.push(e);const s=W(e);this.elbowDepthScoreSamples.push(s),console.log(`ðŸ“Š [${this.exercise.name}] Rep ${this.currentSetReps} - Min angle: ${e.toFixed(1)}Â° â†’ Score: ${s}/10`),this.currentRepElbowAngles=[]}this.stateFrameCount=0,this.repStarted=!1}}else this.stateFrameCount=0}}trackTimer(t){if(!this.holdCompleted){if(this.repState===this.exercise.initState)!this.repStarted&&this.exercise.canStart(t)?(this.stateFrameCount++,this.stateFrameCount>=this.consecutiveFramesRequired&&(this.repState=this.exercise.activeState,this.repStarted=!0,this.stateFrameCount=0,this.holdStartTime=this.videoElement.currentTime,this.currentSetReps=0,console.log(`ðŸŸ¢ Hold START at ${this.holdStartTime.toFixed(2)}s`))):this.stateFrameCount=0;else if(this.repState===this.exercise.activeState){if(this.holdStartTime!=null){const e=Math.max(0,this.videoElement.currentTime-this.holdStartTime),s=Math.floor(e);s!==this.currentSetReps&&(this.currentSetReps=s),this.currentSetDisplay=Math.round(e*10)/10}if(this.repStarted&&this.exercise.canComplete(t)){if(this.stateFrameCount++,this.stateFrameCount>=this.consecutiveFramesRequired){const e=this.videoElement.currentTime;if(this.repState=this.exercise.initState,this.stateFrameCount=0,this.repStarted=!1,this.holdStartTime!=null){const s=Math.max(0,e-this.holdStartTime);this.currentSetReps=Math.max(this.currentSetReps,Math.floor(s)),console.log(`ðŸ”´ Hold STOP at ${e.toFixed(2)}s (duration: ${s.toFixed(2)}s)`),this.holdCompleted=!0}}}else this.stateFrameCount=0}}}sampleQuality(t){var i,l,c,h,p,u,d,n,g,S,m,y,L,E;if(!this.exercise||this.repState!==this.exercise.activeState)return;let e=null;const s=this.exercise.name||"";if(s.toLowerCase().includes("planche")){const r=X(t,this.exercise);e=r==null?void 0:r.avgScore,(r==null?void 0:r.leanScore)!=null&&this.leanScoreSamples.push(r.leanScore),(r==null?void 0:r.trunkScore)!=null&&this.trunkScoreSamples.push(r.trunkScore),(r==null?void 0:r.alignmentScore)!=null&&this.alignmentScoreSamples.push(r.alignmentScore),(r==null?void 0:r.kneeHipShoulderScore)!=null&&this.kneeHipShoulderScoreSamples.push(r.kneeHipShoulderScore),(r==null?void 0:r.straightLegsScore)!=null&&this.straightLegsScoreSamples.push(r.straightLegsScore);const a=(l=(i=this.exercise)._poseMetrics)==null?void 0:l.call(i,t);if(a){const f=a.aL==null?a.aR:a.aR==null?a.aL:(a.aL+a.aR)/2,v=a.shHipYL==null?a.shHipYR:a.shHipYR==null?a.shHipYL:(a.shHipYL+a.shHipYR)/2,M=a.shWrXL==null?a.shWrXR:a.shWrXR==null?a.shWrXL:(a.shWrXL+a.shWrXR)/2,b=a.hkaAngleL==null?a.hkaAngleR:a.hkaAngleR==null?a.hkaAngleL:(a.hkaAngleL+a.hkaAngleR)/2,k=a.khsAngleL==null?a.khsAngleR:a.khsAngleR==null?a.khsAngleL:(a.khsAngleL+a.khsAngleR)/2;f!=null&&this.alignmentAngleSamples.push(f),v!=null&&this.shHipYSamples.push(v),M!=null&&this.shWrXSamples.push(M),b!=null&&this.hkaAngleSamples.push(b),k!=null&&this.khsAngleSamples.push(k)}}else if(s==="Front Lever"||s==="Front Lever Raises"||s==="Tuck Front Lever"||s==="Straddle Front Lever"){let r=null,a=null;const f=(h=(c=this.exercise)._elbowAngles)==null?void 0:h.call(c,t);f!=null&&(r=D(f,155,T),r!=null&&this.frontLeverElbowScoreSamples.push(r),this.frontLeverElbowAngleSamples.push(f));const v=(u=(p=this.exercise)._bodyAlignment)==null?void 0:u.call(p,t);v!=null&&(a=D(v,175,T),a!=null&&this.frontLeverAlignmentScoreSamples.push(a),this.frontLeverAlignmentAngleSamples.push(v)),r!=null&&a!=null?e=(r+a)/2:r!=null?e=r:a!=null&&(e=a)}else if(this.exercise.mode==="hold"&&typeof this.exercise._effectiveAngle=="function"){const r=this.exercise._effectiveAngle(t);if(e=D(r,175,T),e!=null&&this.alignmentScoreSamples.push(e),r!=null&&this.alignmentAngleSamples.push(r),s==="Handstand"){const a=t[11],f=t[12],v=t[27],M=t[28],b=o(a,.4)&&o(v,.4),k=o(f,.4)&&o(M,.4),R=b&&k?{x:(a.x+f.x)/2,y:(a.y+f.y)/2}:b?a:k?f:null,F=b&&k?{x:(v.x+M.x)/2,y:(v.y+M.y)/2}:b?v:k?M:null;if(R&&F){const $=z(R,F,T);if($!=null){this.verticalityScoreSamples.push($);const P=F.x-R.x,q=F.y-R.y,V=Math.atan2(Math.abs(P),Math.abs(q))*180/Math.PI;this.verticalityAngleSamples.push(V)}}}}else if(s==="Handstand Push Up"){const r=(n=(d=this.exercise)._elbowAngles)==null?void 0:n.call(d,t),a=this.repState===this.exercise.initState?"ðŸ”¼":"ðŸ”½";console.log(`${a} [HSPU Frame] State: ${this.repState} | Angle coude: ${r==null?void 0:r.toFixed(1)}Â° | Frames: ${this.stateFrameCount}/${this.consecutiveFramesRequired}`);const f=(S=(g=this.exercise)._bodyAlignment)==null?void 0:S.call(g,t),v=D(f,180,T);this.repState===this.exercise.activeState&&r!=null&&this.currentRepElbowAngles.push(r),v!=null&&(this.alignmentScoreSamples.push(v),f!=null&&this.alignmentAngleSamples.push(f)),e=null}else if(s==="90 Degree HSPU"){const r=(y=(m=this.exercise)._poseMetrics)==null?void 0:y.call(m,t),a=r?r.elbowL??r.elbowR:null,f=(E=(L=this.exercise)._bodyAlignment)==null?void 0:E.call(L,t),v=D(f,180,T);this.repState===this.exercise.activeState&&a!=null&&this.currentRepElbowAngles.push(a),v!=null&&(this.alignmentScoreSamples.push(v),f!=null&&this.alignmentAngleSamples.push(f)),e=null}e!=null&&this.qualitySamples.push(e)}drawLandmarks(t){const e=[[11,12],[11,23],[12,24],[23,24],[11,13],[13,15],[12,14],[14,16],[23,25],[25,27],[24,26],[26,28]];this.ctx.strokeStyle="#00ff00",this.ctx.lineWidth=3,e.forEach(([i,l])=>{const c=t[i],h=t[l];c&&h&&o(c,.3)&&o(h,.3)&&(this.ctx.beginPath(),this.ctx.moveTo(c.x*this.canvasElement.width,c.y*this.canvasElement.height),this.ctx.lineTo(h.x*this.canvasElement.width,h.y*this.canvasElement.height),this.ctx.stroke())}),this.ctx.fillStyle="#ff0000",[0,11,12,13,14,15,16,23,24,25,26,27,28].forEach(i=>{const l=t[i];l&&o(l,.3)&&(this.ctx.beginPath(),this.ctx.arc(l.x*this.canvasElement.width,l.y*this.canvasElement.height,5,0,2*Math.PI),this.ctx.fill())})}finalizeAnalysis(){this.isAnalyzing=!1,this.videoElement.pause();const t={leanScore:this.leanScoreSamples.length>0?Math.round(A(this.leanScoreSamples)*10)/10:null,trunkScore:this.trunkScoreSamples.length>0?Math.round(A(this.trunkScoreSamples)*10)/10:null,alignmentScore:this.alignmentScoreSamples.length>0?Math.round(A(this.alignmentScoreSamples)*10)/10:null,kneeHipShoulderScore:this.kneeHipShoulderScoreSamples.length>0?Math.round(A(this.kneeHipShoulderScoreSamples)*10)/10:null,straightLegsScore:this.straightLegsScoreSamples.length>0?Math.round(A(this.straightLegsScoreSamples)*10)/10:null,verticalityScore:this.verticalityScoreSamples.length>0?Math.round(A(this.verticalityScoreSamples)*10)/10:null,elbowDepthScore:this.elbowDepthScoreSamples.length>0?Math.round(A(this.elbowDepthScoreSamples)*10)/10:null,alignmentAngle:this.alignmentAngleSamples.length>0?Math.round(A(this.alignmentAngleSamples)*10)/10:null,verticalityAngle:this.verticalityAngleSamples.length>0?Math.round(A(this.verticalityAngleSamples)*10)/10:null,frontLeverElbowScore:this.frontLeverElbowScoreSamples.length>0?Math.round(A(this.frontLeverElbowScoreSamples)*10)/10:null,frontLeverAlignmentScore:this.frontLeverAlignmentScoreSamples.length>0?Math.round(A(this.frontLeverAlignmentScoreSamples)*10)/10:null,frontLeverElbowAngle:this.frontLeverElbowAngleSamples.length>0?Math.round(A(this.frontLeverElbowAngleSamples)*10)/10:null,frontLeverAlignmentAngle:this.frontLeverAlignmentAngleSamples.length>0?Math.round(A(this.frontLeverAlignmentAngleSamples)*10)/10:null,shHipY:this.shHipYSamples.length>0?Math.round(A(this.shHipYSamples)*1e3)/1e3:null,shWrX:this.shWrXSamples.length>0?Math.round(A(this.shWrXSamples)*1e3)/1e3:null,hkaAngle:this.hkaAngleSamples.length>0?Math.round(A(this.hkaAngleSamples)*10)/10:null,khsAngle:this.khsAngleSamples.length>0?Math.round(A(this.khsAngleSamples)*10)/10:null,elbowAngle:this.elbowAngleSamples.length>0?Math.round(A(this.elbowAngleSamples)*10)/10:null};let e=null;if((this.exercise.name==="Handstand Push Up"||this.exercise.name==="90 Degree HSPU")&&t.elbowDepthScore!=null&&t.alignmentScore!=null)e=Math.round((t.elbowDepthScore+t.alignmentScore)/2*10)/10,console.log(`[VA] Score global calculÃ©: (${t.elbowDepthScore} + ${t.alignmentScore}) / 2 = ${e}`);else if(this.qualitySamples.length>0){const s=this.qualitySamples.length>3?this.qualitySamples.slice(0,-3):this.qualitySamples,i=A(s);e=i!=null?Math.round(i*10)/10:null}this.displayResults(e,t)}displayResults(t,e){document.getElementById("progressBar").classList.remove("active"),document.getElementById("status").classList.remove("active"),document.getElementById("results").classList.add("active"),document.getElementById("resultExerciseName").textContent=this.exercise.name;const s=this.exercise.tracking==="timer"||this.exercise.mode==="hold";if(document.getElementById("resultLabel").textContent=s?"DurÃ©e du hold":"RÃ©pÃ©titions",document.getElementById("resultValue").textContent=s?`${this.currentSetDisplay||this.currentSetReps}s`:this.currentSetReps,t!=null){const i=document.getElementById("qualityScoreSection");i.style.display="block";const l=document.getElementById("qualityScoreValue");l.textContent=`${t}/10`,l.classList.remove("excellent","good","poor"),t>=9?l.classList.add("excellent"):t>=7?l.classList.add("good"):l.classList.add("poor"),this.displayQualityDetails(e)}else document.getElementById("qualityScoreSection").style.display="none"}displayQualityDetails(t){const e=document.getElementById("qualityDetails");e.innerHTML="";const s=this.exercise.name,i=s==="Handstand",l=s==="Handstand Push Up",c=s==="90 Degree HSPU",h=s==="Adv. tuck planche",p=s==="Straddle planche"||s==="Full planche"||s==="Planche lean"||s==="Front Lever",u=[];if(t.alignmentScore!=null&&!l&&!c){const n=t.alignmentAngle!=null?` (Moy: ${t.alignmentAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ“",name:i?"Alignement corps":"Alignement",score:t.alignmentScore,description:`${i?"Ã‰paules-hanches-chevilles droites":"Alignement Ã©paules-hanches-chevilles"}${n}`})}if(t.verticalityScore!=null&&i){const n=t.verticalityAngle!=null?` (Moy: ${t.verticalityAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ“",name:"VerticalitÃ©",score:t.verticalityScore,description:`Alignement par rapport Ã  la verticale${n}`})}if(t.leanScore!=null&&!i){const n=t.shWrX!=null?` (shWrX: ${t.shWrX.toFixed(3)})`:"";u.push({icon:"ðŸ’Ž",name:"Lean (avancÃ©e)",score:t.leanScore,description:`Position des Ã©paules par rapport aux poignets${n}`})}if(t.trunkScore!=null){const n=t.shHipY!=null?` (shHipY: ${t.shHipY.toFixed(3)})`:"";u.push({icon:"ðŸŽ¯",name:"Tronc",score:t.trunkScore,description:`Alignement du tronc${n}`})}if(t.kneeHipShoulderScore!=null&&h){const n=t.khsAngle!=null?` (Moy: ${t.khsAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ¦µ",name:"Genou-Hanche-Ã‰paule",score:t.kneeHipShoulderScore,description:`Alignement spÃ©cifique Advanced Tuck${n}`})}if(t.straightLegsScore!=null&&p){const n=t.hkaAngle!=null?` (Moy: ${t.hkaAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ¦µ",name:"Jambes tendues",score:t.straightLegsScore,description:`Extension des jambes${n}`})}const d=s==="Front Lever Raises"||s==="Tuck Front Lever"||s==="Straddle Front Lever";if(t.frontLeverElbowScore!=null&&d){const n=t.frontLeverElbowAngle!=null?` (Moy: ${t.frontLeverElbowAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ’ª",name:"Verrouillage des coudes",score:t.frontLeverElbowScore,description:`Extension complÃ¨te des bras${n}`})}if(t.frontLeverAlignmentScore!=null&&d){const n=t.frontLeverAlignmentAngle!=null?` (Moy: ${t.frontLeverAlignmentAngle.toFixed(1)}Â°)`:"";u.push({icon:"âš–ï¸",name:"Alignement horizontal",score:t.frontLeverAlignmentScore,description:`Ã‰paules-hanches-chevilles alignÃ©s${n}`})}if(t.elbowDepthScore!=null&&(l||c)){const n=t.elbowAngle!=null?` (Moy: ${t.elbowAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ’ª",name:"Profondeur coude",score:t.elbowDepthScore,description:`Angle du coude Ã  la descente${n}`})}if(t.alignmentScore!=null&&(l||c)){const n=t.alignmentAngle!=null?` (Moy: ${t.alignmentAngle.toFixed(1)}Â°)`:"";u.push({icon:"ðŸ“",name:"Alignement du corps",score:t.alignmentScore,description:`Ã‰paules-hanches-chevilles droites${n}`})}u.forEach(n=>{const g=document.createElement("div");g.className="quality-detail-item",g.innerHTML=`
        <div class="quality-detail-icon">${n.icon}</div>
        <div class="quality-detail-name">${n.name}</div>
        <div class="quality-detail-score">${n.score}/10</div>
        <div class="quality-detail-description">${n.description}</div>
      `,e.appendChild(g)})}showStatus(t,e){const s=document.getElementById("status");s.textContent=t,s.className=`status active ${e}`}reanalyze(){document.getElementById("results").classList.remove("active"),document.getElementById("progressBar").classList.remove("active"),document.getElementById("status").classList.remove("active"),this.isAnalyzing=!1,this.currentSetReps=0,this.currentSetDisplay=0,this.repState=null,this.repStarted=!1,this.stateFrameCount=0,this.holdStartTime=null,this.qualitySamples=[],this.leanScoreSamples=[],this.trunkScoreSamples=[],this.alignmentScoreSamples=[],this.kneeHipShoulderScoreSamples=[],this.straightLegsScoreSamples=[],this.verticalityScoreSamples=[],this.elbowDepthScoreSamples=[],this.alignmentAngleSamples=[],this.verticalityAngleSamples=[],this.videoElement.currentTime=0,this.videoElement.pause(),this.ctx.clearRect(0,0,this.canvasElement.width,this.canvasElement.height),this.startAnalysis()}restart(){document.getElementById("uploadSection").style.display="block",document.getElementById("videoPreview").classList.remove("active"),document.getElementById("results").classList.remove("active"),document.getElementById("progressBar").classList.remove("active"),document.getElementById("status").classList.remove("active"),document.getElementById("videoFile").value="",document.getElementById("analyzeBtn").disabled=!0,this.videoElement.src="",this.videoElement.load(),this.isAnalyzing=!1}}document.addEventListener("DOMContentLoaded",()=>{new Z});
